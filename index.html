<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FitDataPro - Cyber OS</title>
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <div id="toast-container"></div>

    <section id="auth-view" class="auth-container">
        <div style="text-align: center; margin-bottom: 30px;">
            <img src="logo.png" alt="FitDataPro Logo"
                style="width: 80px; height: 80px; border-radius: 20px; margin-bottom: 15px; box-shadow: 0 0 20px var(--cyber-red-dim);">
            <h1 style="font-size: 36px; font-weight: 900; letter-spacing: -1px;">FIT<span
                    class="highlight">DATA</span>PRO</h1>
            <p style="color: var(--cyber-text-gray); font-size: 14px;">Red Neuronal de Entrenamiento</p>
        </div>

        <div class="liquid-glass" style="width: 100%; max-width: 400px; padding: 30px 20px;">
            <div id="login-section">
                <form id="login-form" class="auth-form">
                    <input type="email" id="login-email" placeholder="Correo Electr√≥nico" required>
                    <input type="password" id="login-password" placeholder="C√≥digo de Acceso" required>
                    <button type="submit" class="cyber-button">Iniciar Sesi√≥n</button>
                </form>
                <div style="display:flex; justify-content:space-between; margin-top:20px;">
                    <p style="font-size: 13px; color: var(--cyber-text-gray);"><a href="#" id="toggle-to-register"
                            class="highlight" style="text-decoration:none;">Solicitar Acceso</a></p>
                    <p style="font-size: 13px;"><a href="#" id="btn-show-install"
                            style="color:#00ff88; text-decoration:none; font-weight:bold;">üì≤ Instalar App</a></p>
                </div>
            </div>

            <div id="register-section" style="display: none;">
                <form id="register-form" class="auth-form">
                    <input type="text" id="reg-name" placeholder="Nombre Operativo" required>
                    <input type="email" id="reg-email" placeholder="Correo" required>
                    <input type="password" id="reg-password" placeholder="Contrase√±a" required>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="select-wrapper">
                            <select id="reg-gender" required>
                                <option value="" disabled selected>G√©nero</option>
                                <option value="masculino">Masculino</option>
                                <option value="femenino">Femenino</option>
                            </select>
                        </div>
                        <input type="date" id="reg-dob" required style="font-size: 14px;">
                    </div>
                    <input type="tel" id="reg-phone" placeholder="Tel√©fono" required>
                    <button type="submit" class="cyber-button">Conectar a la Red</button>
                </form>
                <p style="margin-top: 20px; text-align: center; font-size: 13px; color: var(--cyber-text-gray);"><a
                        href="#" id="toggle-to-login" class="highlight" style="text-decoration:none;">Autenticarse</a>
                </p>
            </div>
        </div>
    </section>

    <section id="app-wrapper">
        <div class="header-title">
            <div style="display:flex; align-items:center;">
                <img src="logo.png" alt="Logo" class="header-logo">
                <span id="header-text">FIT<span class="highlight">DATA</span>PRO</span>
            </div>
            <svg class="cyber-icon highlight" viewBox="0 0 24 24" style="width:24px; height:24px;">
                <path
                    d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-2h2v2zm0-4h-2V7h2v6z" />
            </svg>
        </div>

        <main id="app-view"></main>

        <nav class="bottom-nav">
            <div class="nav-item" data-view="menu"><svg class="cyber-icon" viewBox="0 0 24 24">
                    <path
                        d="M4 4h4v4H4zm6 0h4v4h-4zm6 0h4v4h-4zM4 10h4v4H4zm6 0h4v4h-4zm6 0h4v4h-4zM4 16h4v4H4zm6 0h4v4h-4zm6 0h4v4h-4z" />
                </svg><span>Men√∫</span></div>
            <div class="nav-item active" data-view="plan"><svg class="cyber-icon" viewBox="0 0 24 24">
                    <path
                        d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 002 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10z" />
                </svg><span>Plan</span></div>
            <button class="fab-button" id="fab-trigger"><svg class="cyber-icon" viewBox="0 0 24 24">
                    <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                </svg></button>
            <div class="nav-item" data-view="progreso"><svg class="cyber-icon" viewBox="0 0 24 24">
                    <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z" />
                </svg><span>Progreso</span></div>
            <div class="nav-item" data-view="mensajes"><svg class="cyber-icon" viewBox="0 0 24 24">
                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z" />
                </svg><span>Mensajes</span></div>
        </nav>

        <div id="active-workout-banner" class="active-workout-banner hidden">
            <div style="display:flex; align-items:center; gap:10px;">
                <div class="pulse-dot"></div><span style="font-weight:bold; font-size:14px; color:white;">Entrenamiento
                    Activo</span>
            </div>
            <span style="font-size:12px; color:var(--cyber-red-neon); font-weight:bold;">Retomar ‚ñ∂</span>
        </div>

        <div id="modal-install" class="modal-overlay">
            <div class="modal-content">
                <h3 style="color:var(--cyber-white); text-align:center; margin-bottom:20px;">Instalar FitDataPro</h3>
                <p style="color:var(--cyber-text-gray); font-size:13px; text-align:center; margin-bottom:20px;">A√±ade la
                    app a tu pantalla de inicio para una experiencia nativa.</p>
                <div class="liquid-glass card" style="margin-bottom:15px; padding:15px;">
                    <h4 style="color:#00d4ff; margin-bottom:10px;">üçé iOS (Safari)</h4>
                    <ol style="color:var(--cyber-text-gray); font-size:12px; margin-left:15px; line-height:1.6;">
                        <li>Toca el icono Compartir abajo.</li>
                        <li>Selecciona "A√±adir a la pantalla de inicio".</li>
                    </ol>
                </div>
                <div class="liquid-glass card" style="padding:15px;">
                    <h4 style="color:#00ff88; margin-bottom:10px;">ü§ñ Android (Chrome)</h4>
                    <ol style="color:var(--cyber-text-gray); font-size:12px; margin-left:15px; line-height:1.6;">
                        <li>Toca el Men√∫ (3 puntos) arriba a la derecha.</li>
                        <li>Selecciona "A√±adir a pantalla de inicio".</li>
                    </ol>
                </div><button class="cyber-button secondary" id="close-install-modal"
                    style="margin-top:20px;">Entendido</button>
            </div>
        </div>

        <div id="fab-modal" class="modal-overlay">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px; text-align: center;">Registrar M√©trica</h3>
                <div class="modal-grid">
                    <div class="modal-action" data-action="weight"><svg class="cyber-icon" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l4.38 2.19L8 16h8l1.62-6.81L22 7l-10-5zM8 18h8v2H8v-2z" />
                        </svg><span>Peso</span></div>
                    <div class="modal-action" data-action="fat"><svg class="cyber-icon" style="color: #ffaa00;"
                            viewBox="0 0 24 24">
                            <path d="M12 2c0 0-4 4-4 9 0 2.21 1.79 4 4 4s4-1.79 4-4c0-5-4-9-4-9z" />
                        </svg><span>% Grasa</span></div>
                    <div class="modal-action" data-action="measures"><svg class="cyber-icon" style="color: #00d4ff;"
                            viewBox="0 0 24 24">
                            <path
                                d="M21.5 5.5l-2-2c-.39-.39-1.02-.39-1.41 0L3 18.59c-.39.39-.39 1.02 0 1.41l2 2c.39.39 1.02.39 1.41 0L21.5 6.91c.39-.39.39-1.02 0-1.41zM6.41 20L4 17.59 5.59 16 7 17.41 8.41 16 7 14.59 8.41 13 9.83 14.41 11.24 13 9.83 11.59 11.24 10.17 12.66 11.59 14.07 10.17 12.66 8.76 14.07 7.34 15.49 8.76 16.9 7.34 15.49 5.93 17.9 3.51 20.31 5.93 6.41 20z" />
                        </svg><span>Pliegues</span></div>
                    <div class="modal-action" data-action="meal"><svg class="cyber-icon" style="color: #44ff44;"
                            viewBox="0 0 24 24">
                            <path
                                d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 6h2v6.27l4.25 2.52-1 1.73-5.25-3.15V6z" />
                        </svg><span>Comida</span></div>
                    <div class="modal-action" id="btn-ia-setup-fab" style="border-color: #ff1f3d;"><svg
                            class="cyber-icon" style="color: var(--cyber-red-neon);" viewBox="0 0 24 24">
                            <path
                                d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22 14.86 20.57 17 22.71 22.71 17z" />
                        </svg><span>Rutina IA</span></div>
                    <div class="modal-action"
                        style="background: rgba(255, 31, 61, 0.2); border-color: var(--cyber-red-neon);"
                        id="close-modal"><svg class="cyber-icon highlight" viewBox="0 0 24 24">
                            <path
                                d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                        </svg><span style="color: var(--cyber-red-neon); font-weight: bold;">Cancelar</span></div>
                </div>
            </div>
        </div>

        <div id="modal-timer" class="modal-overlay">
            <div class="modal-content" style="text-align:center;">
                <h3 style="color:var(--cyber-text-gray); font-size:14px; letter-spacing:2px; margin-bottom:10px;">
                    RECUPERACI√ìN</h3>
                <div id="timer-display-main" class="timer-display-huge">01:30</div>
                <div style="display:flex; gap:10px; justify-content:center; margin-bottom:20px;">
                    <button class="cyber-button secondary" id="btn-timer-minus" style="flex:1;">-15s</button>
                    <button class="cyber-button secondary" id="btn-timer-plus" style="flex:1;">+15s</button>
                </div>
                <button class="cyber-button" id="btn-timer-skip">Saltar Descanso ‚ñ∂</button>
            </div>
        </div>

        <div id="modal-rpe" class="modal-overlay">
            <div class="modal-content" style="text-align:center;">
                <h3 style="color:white; margin-bottom:10px; font-size:18px;">Resumen Operativo</h3>

                <div class="scanner-wrapper" id="workout-muscle-map"></div>

                <textarea id="workout-general-note" class="auth-form"
                    placeholder="Nota general de tu entreno (Sensaciones, energ√≠a, etc.)..."
                    style="width:100%; min-height:60px; margin-bottom:15px; border-radius:8px; padding:10px; background:rgba(10,10,10,0.5); color:white; border:1px solid rgba(255,31,61,0.3); font-family:inherit;"></textarea>

                <p style="color:var(--cyber-text-gray); font-size:14px; margin-bottom:15px;">Evaluaci√≥n de Esfuerzo
                    (RPE)</p>
                <div style="display:flex; gap:10px; margin-bottom: 20px;">
                    <button class="cyber-button" style="flex:1; background:#00ff88; color:black;" data-rpe="Suave">üü¢
                        Suave</button>
                    <button class="cyber-button" style="flex:1; background:#ffaa00; color:black;" data-rpe="Duro">üü†
                        Duro</button>
                    <button class="cyber-button" style="flex:1; background:#ff3333; color:white;" data-rpe="Fallo">üî¥
                        Fallo</button>
                </div>

                <button class="cyber-button secondary" id="btn-back-workout">‚Üê Me dej√© algo (Volver)</button>
            </div>
        </div>

        <div id="modal-payment" class="modal-overlay">
            <div class="modal-content">
                <h3 style="margin-bottom: 20px; text-align: center;">Completar Suscripci√≥n</h3>
                <p style="color:var(--cyber-text-gray); font-size:13px; text-align:center; margin-bottom:20px;">Elige tu
                    m√©todo de pago para activar el plan.</p>
                <div style="display:flex; flex-direction:column; gap:15px;">
                    <button class="cyber-button" id="btn-pay-bizum"
                        style="background:#00c4b3; color:white; text-shadow:none; box-shadow:0 0 15px rgba(0,196,179,0.4);">Pagar
                        con Bizum (0% Comisiones)</button>
                    <button class="cyber-button" id="btn-pay-sumup"
                        style="background:#0f1e32; border:1px solid #fff; color:white; text-shadow:none; box-shadow:none;">Pagar
                        con Tarjeta (SumUp)</button>
                    <button class="cyber-button secondary" id="close-payment-modal"
                        style="margin-top:10px; border-color:#666; color:#888;">Cancelar</button>
                </div>
            </div>
        </div>

        <div id="modal-swap" class="modal-overlay">
            <div class="modal-content">
                <h3 style="margin-bottom: 15px; text-align: center;">Cambiar M√°quina</h3>
                <p style="color:var(--cyber-text-gray); font-size:12px; text-align:center; margin-bottom:15px;">Elige
                    una alternativa del mismo grupo muscular:</p>
                <div id="swap-list-container" class="swap-list"></div>
                <button class="cyber-button secondary" id="close-swap-modal" style="margin-top:15px;">Cancelar</button>
            </div>
        </div>

    </section>

    <script type="module">
        import { auth, db, loadUserData, loadHistory, updateProfile, saveWorkout, uploadComparativaImage } from './js/firebase.js';
        import { AdminController } from './js/admin.js';
        import { EXERCISES } from './js/data.js';
        import { createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(e => { }); }); }

        // Pedir permisos de Notificaci√≥n Push
        if ("Notification" in window) {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') console.log("Permiso de notificaciones concedido.");
            });
        }

        const loginSection = document.getElementById('login-section');
        const registerSection = document.getElementById('register-section');
        document.getElementById('toggle-to-register').addEventListener('pointerup', () => { loginSection.style.display = 'none'; registerSection.style.display = 'block'; });
        document.getElementById('toggle-to-login').addEventListener('pointerup', () => { registerSection.style.display = 'none'; loginSection.style.display = 'block'; });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button'); btn.disabled = true;
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value);
                // We reload the page to ensure completely clean state on login
                window.location.reload();
            }
            catch (error) { alert('Error: ' + error.message); }
            finally { btn.disabled = false; }
        });

        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.textContent = 'Procesando...';
            try {
                const name = document.getElementById('reg-name').value;
                const email = document.getElementById('reg-email').value;
                const password = document.getElementById('reg-password').value;
                const gender = document.getElementById('reg-gender').value;
                const dob = document.getElementById('reg-dob').value;
                const phone = document.getElementById('reg-phone').value;

                console.log("Registrando usuario:", email);
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Transacci√≥n para ID autoincremental
                const counterRef = doc(db, "system", "counters");
                let newIdNum = 1;
                try {
                    newIdNum = await AdminController.getOptimizedIncrementCounter(); // Note: If runTransaction isn't available here, we'll just fall back, but ideally auth.js handles this now. Since we are in index.html we let auth.js handle it if they use the other register form, else we do it here.
                } catch (e) { } // Quick fallback for older signup path natively in index.html

                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    clientIdNum: newIdNum, // Guardar el ID auto-incremental generado
                    fullName: name,
                    email: email,
                    gender: gender,
                    dob: dob,
                    phone: phone,
                    status: 'pending',
                    role: 'user',
                    createdAt: serverTimestamp()
                });

                alert('Registro completado. Tu cuenta est√° pendiente de aprobaci√≥n por el Coach.');
                // Forzar cierre de sesi√≥n para que no entre a la app y deba esperar aprobaci√≥n
                await signOut(auth);
                document.getElementById('toggle-to-login').click();
            } catch (error) {
                console.error("Registration error:", error);
                alert('Error al registrar: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Conectar a la Red';
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Cargar datos de Firestore al Estado
                const userData = await loadUserData(user.uid);

                // Verificar si est√° aprobado
                if (userData && userData.status !== 'approved' && userData.role !== 'admin') {
                    alert('Tu cuenta a√∫n no ha sido aprobada por el administrador.');
                    await signOut(auth);
                    return;
                }

                document.getElementById('auth-view').style.display = 'none';
                document.getElementById('app-wrapper').style.display = 'block';

                if (userData) {
                    State.profile.maxWeights = userData.maxWeights || {};
                    State.profile.rmRecords = userData.rmRecords || {};
                    State.profile.machineNotes = userData.machineNotes || {};
                    if (userData.comparativaImages) State.comparativaImages = userData.comparativaImages;
                    State.profile.role = userData.role || 'user';
                    State.messages = userData.messages || [];

                    // Plan de Entrenamiento Din√°mico
                    if (userData.plan && userData.plan.routinesAvailable) {
                        State.plan.name = userData.plan.name || "Plan Activo";
                        State.plan.routinesAvailable = userData.plan.routinesAvailable;
                    } else if (userData.assignedRoutine) {
                        // Retrocompatibilidad con rutinas √∫nicas
                        State.plan.name = "Rutina Simple";
                        State.plan.routinesAvailable = [{
                            routineName: userData.assignedRoutine.name,
                            exercises: userData.assignedRoutine.exercises || []
                        }];
                    } else {
                        State.plan.name = "Sin Plan Activo";
                        State.plan.routinesAvailable = [];
                    }

                } else {
                    State.profile.maxWeights = {};
                    State.profile.rmRecords = {};
                    State.profile.machineNotes = {};
                    State.profile.role = 'user';
                    State.messages = [];
                }
                State.profile.id = user.uid.substring(0, 4).toUpperCase();
                State.profile.uid = user.uid;

                // GLOBAL LISTENER PARA RECORDATORIOS AUTOM√ÅTICOS PUSH
                if (State.profile.role !== 'admin') {
                    if (window.globalUserUnsubscribe) window.globalUserUnsubscribe();
                    const { onSnapshot, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js");
                    window.globalUserUnsubscribe = onSnapshot(doc(db, "users", user.uid), async (docSnap) => {
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            const reminders = data.automaticReminders || [];
                            const now = Date.now();
                            let updated = false;

                            reminders.forEach(r => {
                                if (now >= r.nextTrigger) {
                                    // DISPARAR NOTIFICACI√ìN PUSH Y CHAT IN-GAME GUI
                                    if (Notification.permission === 'granted') {
                                        try {
                                            navigator.serviceWorker.ready.then(registration => {
                                                registration.showNotification('Planificaci√≥n Coach', { body: r.text, icon: 'img/logo.png' });
                                            }).catch(() => { new Notification('Planificaci√≥n Coach', { body: r.text, icon: 'img/logo.png' }); });
                                        } catch (e) { }
                                    }
                                    showToast(r.text);

                                    // Re-programar para el siguiente ciclo
                                    r.nextTrigger = now + (r.freqDays * 24 * 60 * 60 * 1000);
                                    updated = true;
                                }
                            });

                            if (updated) {
                                await updateDoc(doc(db, "users", user.uid), { automaticReminders: reminders });
                            }
                        }
                    });
                }

                // Cargar Historial
                State.history = await loadHistory(user.uid);

                if (State.profile.role === 'admin') {
                    navigateTo('admin_dashboard');
                } else {
                    navigateTo('plan');
                }
            } else {
                document.getElementById('auth-view').style.display = 'flex';
                document.getElementById('app-wrapper').style.display = 'none';
            }
        });

        function calculateAge(dobString) {
            if (!dobString) return 30;
            const today = new Date(); const birthDate = new Date(dobString);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
            return age;
        }

        function calculateJP7(sum7, age, gender) {
            if (!sum7 || !age) return '';
            let bd = 0;
            if (gender === 'femenino') bd = 1.097 - (0.00046971 * sum7) + (0.00000056 * (sum7 * sum7)) - (0.00012828 * age);
            else bd = 1.112 - (0.00043499 * sum7) + (0.00000055 * (sum7 * sum7)) - (0.00028826 * age);
            let fat = (495 / bd) - 450;
            return fat > 0 ? fat.toFixed(1) : '';
        }

        // ==========================================
        // ROUTINE BUILDER & EXECUTION LOGIC
        // ==========================================
        window.startAssignedRoutine = (index) => {
            const selectedRoutine = State.plan.routinesAvailable[index];
            if (!selectedRoutine || !selectedRoutine.exercises) return alert("Rutina no v√°lida.");

            State.activeWorkout = selectedRoutine.exercises.map(ex => {
                // Si la rutina maestra ya tiene sets guardados (ej: 4 series, 12 reps), los respetamos, 
                // sino generamos placeholders
                let setsArray = [];
                if (ex.s) {
                    const repsPattern = String(ex.s).split('-');
                    for (let i = 0; i < repsPattern.length; i++) {
                        setsArray.push({ id: i + 1, targetR: parseInt(repsPattern[i]) || 12, r: '', w: '', done: false, prevW: 0, prevR: 0, isDrop: false });
                    }
                } else {
                    setsArray = [
                        { id: 1, targetR: 12, r: '', w: '', done: false, prevW: 0, prevR: 0, isDrop: false },
                        { id: 2, targetR: 12, r: '', w: '', done: false, prevW: 0, prevR: 0, isDrop: false },
                        { id: 3, targetR: 12, r: '', w: '', done: false, prevW: 0, prevR: 0, isDrop: false },
                        { id: 4, targetR: 12, r: '', w: '', done: false, prevW: 0, prevR: 0, isDrop: false }
                    ];
                }

                return {
                    name: ex.n,
                    notes: '',
                    obs: '',
                    sets: setsArray
                };
            });

            // Guardamos el √≠ndice actual para borrarlo cuando finalice el entreno si queremos ir elimin√°ndolos de la lista de pendientes (L√≥gica futura)
            State.currentExerciseIndex = 0;
            navigateTo('workout_player');
        };

        window.rbNormalized = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

        window.rbFilter = () => {
            window.rbCurrentRenderCount = 20;
            rbRenderList();
        };

        window.rbRenderList = () => {
            const query = document.getElementById('rb-search').value;
            const normQ = rbNormalized(query);
            const container = document.getElementById('rb-list-container');
            if (!container) return;

            let filtered = EXERCISES;
            if (normQ) filtered = EXERCISES.filter(ex => rbNormalized(ex.n).includes(normQ) || rbNormalized(ex.m).includes(normQ));

            const toRender = filtered.slice(0, window.rbCurrentRenderCount);

            container.innerHTML = toRender.map(ex => {
                const selObj = window.currentRoutineSelections.find(s => s.n === ex.n);
                if (selObj) {
                    return `
                    <div id="card-${ex.n.replace(/[\w\s]/g, '-')}" class="liquid-glass card routine-card-active" style="border: 1px solid var(--cyber-red-neon); padding: 12px; display:flex; flex-direction:column; gap:8px; border-radius:8px; margin-bottom:10px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <img src="${ex.img}" onerror="this.src='logo.png'" style="width:30px; height:30px; object-fit:contain; border-radius:4px; background:rgba(255,255,255,0.05); padding:2px;">
                                <span style="color:var(--cyber-white); font-weight:bold; font-size:12px;">${ex.n}</span>
                            </div>
                            <button onclick="rbRemove('${ex.n}')" style="background:transparent; border:none; color:#ff3333; font-size:16px; cursor:pointer; padding:0 5px;">‚úï</button>
                        </div>
                        <div style="display:flex; gap:6px; align-items:center;">
                            <input type="text" value="${selObj.series}" onchange="rbUpdate('${ex.n}', 'series', this.value)" placeholder="S" style="width: 35px; background:rgba(0,0,0,0.5); border:1px solid #444; color:white; padding:4px; border-radius:4px; font-size:11px; text-align:center;">
                            <span style="color:#666; font-size:10px;">x</span>
                            <input type="text" value="${selObj.reps}" onchange="rbUpdate('${ex.n}', 'reps', this.value)" placeholder="ej: 20-16-16-16" style="flex:1; background:rgba(0,0,0,0.5); border:1px solid #444; color:white; padding:4px 6px; border-radius:4px; font-size:11px;">
                            <button onclick="rbToggleSuperset('${ex.n}')" class="cyber-button secondary ${selObj.s ? 'superset-active' : ''}" style="min-width:30px; width:30px; height:26px; padding:0; display:flex; align-items:center; justify-content:center; font-size:12px; border-color:${selObj.s ? '#00d4ff' : '#444'}; color:${selObj.s ? '#00d4ff' : '#555'}; transition: 0.3s; box-shadow:${selObj.s ? '0 0 10px rgba(0,212,255,0.3)' : 'none'};" title="Enlazar en Superserie">üîó</button>
                        </div>
                    </div>`;
                } else {
                    return `
                    <div class="ex-list-item card" onclick="rbAdd('${ex.n}')" style="display:flex; align-items:center; gap:15px; padding:10px; background:rgba(20,20,20,0.8); border:1px solid #333; margin-bottom:10px; border-radius:8px; cursor:pointer;">
                        <img src="${ex.img}" onerror="this.src='logo.png'" style="width:35px; height:35px; object-fit:contain; border-radius:4px; background:rgba(255,255,255,0.05); padding:2px;">
                        <span style="color:white; font-size:14px; flex:1;">${ex.n}</span>
                        <span style="color:#555; font-size:11px;">+</span>
                    </div>`;
                }
            }).join('');

            rbUpdateLegend();
        };

        window.rbAdd = (name) => {
            if (!window.currentRoutineSelections.find(s => s.n === name)) {
                window.currentRoutineSelections.push({ n: name, s: false, series: 4, reps: "12" });
                rbRenderList();
            }
        };

        window.rbRemove = (name) => {
            window.currentRoutineSelections = window.currentRoutineSelections.filter(s => s.n !== name);
            rbRenderList();
        };

        window.rbUpdate = (name, field, val) => {
            const obj = window.currentRoutineSelections.find(s => s.n === name);
            if (obj) obj[field] = val;
        };

        window.rbToggleSuperset = (name) => {
            const idx = window.currentRoutineSelections.findIndex(s => s.n === name);
            if (idx === -1) return;
            if (idx === window.currentRoutineSelections.length - 1) {
                alert("No puedes crear superserie en el √∫ltimo ejercicio. A√±ade otro primero.");
                return;
            }
            const obj = window.currentRoutineSelections[idx];
            obj.s = !obj.s;
            rbRenderList();
        };

        window.rbScrollTo = (name) => {
            const cleanName = name.replace(/[\w\s]/g, '-');
            const el = document.getElementById(`card-${cleanName}`);
            if (el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.backgroundColor = 'rgba(255,31,61,0.2)';
                setTimeout(() => el.style.backgroundColor = 'transparent', 800);
            }
        };

        window.rbUpdateLegend = () => {
            const legend = document.getElementById('rb-sticky-legend');
            if (!legend) return;
            if (window.currentRoutineSelections.length === 0) {
                legend.style.display = 'none';
                return;
            }
            legend.style.display = 'flex';

            let html = '';
            window.currentRoutineSelections.forEach((sel, i) => {
                html += `<div onclick="rbScrollTo('${sel.n}')" style="cursor:pointer; display:flex; align-items:center; background:rgba(255,31,61,0.1); border:1px solid var(--cyber-red-neon); padding:6px 10px; border-radius:12px; white-space:nowrap; font-size:11px; color:white; transition: 0.2s;">
                    <span style="color:var(--cyber-red-neon); margin-right:4px;">${i + 1}.</span> ${sel.n}
                </div>`;
                if (sel.s && i < window.currentRoutineSelections.length - 1) {
                    html += `<span style="color:#00d4ff; font-size:14px; display:flex; align-items:center;">üîó</span>`;
                } else if (i < window.currentRoutineSelections.length - 1) {
                    html += `<span style="color:#555; font-size:10px; display:flex; align-items:center; margin-left:2px; margin-right:2px;">‚ñ∂</span>`;
                }
            });
            legend.innerHTML = html;
        };

        window.rbSetupObserver = () => {
            const target = document.getElementById('rb-observer-target');
            if (!target) return;
            const observer = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    const query = document.getElementById('rb-search').value;
                    const normQ = rbNormalized(query);
                    let filtered = EXERCISES;
                    if (normQ) filtered = EXERCISES.filter(ex => rbNormalized(ex.n).includes(normQ) || rbNormalized(ex.m).includes(normQ));

                    if (window.rbCurrentRenderCount < filtered.length) {
                        window.rbCurrentRenderCount += 20;
                        rbRenderList();
                    }
                }
            }, { rootMargin: '200px' });
            observer.observe(target);
        };

        window.initRoutineBuilder = () => {
            window.currentRoutineSelections = [];
            window.rbCurrentRenderCount = 20;

            const contentArea = document.getElementById('admin-subcontent');
            contentArea.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <button onclick="loadAdminContent('rutinas')" class="cyber-button secondary" style="min-width:auto; padding:5px 10px; font-size:11px;">‚Üª</button>
                    <button onclick="saveAdminRoutine()" class="cyber-button" style="background:#00ff88; color:black; border:none; padding:8px 20px; font-weight:bold; min-width:auto; border-radius:6px; font-size:12px; box-shadow: 0 0 10px rgba(0,255,136,0.3);">GUARDAR RUTINA</button>
                </div>
                
                <input type="text" id="draft-r-name" placeholder="Escribe el nombre de esta rutina..." autocomplete="off" style="width:100%; padding:15px; background:rgba(10,10,10,0.8); border:1px solid #444; color:white; border-radius:6px; margin-bottom:15px; font-size:14px;">

                <!-- Sticky Legend -->
                <div id="rb-sticky-legend" class="routine-top-legend" style="display:none; position:sticky; top:0; z-index:100; background:rgba(0,0,0,0.95); padding:10px 0; overflow-x:auto; gap:8px; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1);"></div>
                
                <div style="position:relative; margin-bottom:15px;">
                    <span style="position:absolute; left:12px; top:12px; opacity:0.6;">üîç</span>
                    <input type="search" id="rb-search" placeholder="Buscar por ejercicio o m√∫sculo..." oninput="rbFilter()" style="width:100%; padding:12px 12px 12px 35px; background:rgba(20,20,20,0.9); border:1px solid #555; color:white; border-radius:6px; font-size:13px;">
                </div>

                <div id="rb-list-container" style="display:flex; flex-direction:column; padding-bottom:20px;">
                    <!-- Actives and Inactives render here -->
                </div>
                
                <div id="rb-observer-target" style="height:40px; margin-top:10px;"></div>
            `;

            rbRenderList();
            setTimeout(rbSetupObserver, 500);
        };

        // CONTROLADOR DE CONTENIDO ADMIN
        window.loadAdminContent = async function (tabName) {
            const contentArea = document.getElementById('admin-subcontent');
            if (!contentArea) return;

            contentArea.innerHTML = `<p style="color:var(--cyber-text-gray); font-size:13px; text-align:center; margin-top:40px;">Cargando m√≥dulo ${tabName}...</p>`;

            try {
                if (tabName === 'atletas') {
                    const pendingUsers = await AdminController.getClients('pending');
                    const activeUsers = await AdminController.getClients('approved');

                    let html = ``;

                    if (pendingUsers.length > 0) {
                        html += `<h3 style="color:#ffcc00; margin-bottom:10px; font-size: 14px;">Atletas Pendientes</h3>`;
                        pendingUsers.forEach(u => {
                            html += `
                            <div class="liquid-glass card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:10px; border-left:3px solid #ffcc00;">
                                <div>
                                    <strong style="color:white; display:block; font-size: 13px;">${u.fullName || 'Atleta Sin Nombre'}</strong>
                                    <span style="font-size:10px; color:#aaa;">${u.email}</span>
                                </div>
                                <div style="display:flex; gap:5px;">
                                    <button onclick="approveAthlete('${u.id}')" class="cyber-button" style="padding:4px 8px; font-size:10px; min-width:auto; border-color:#00ff88; color:#00ff88;">‚úì</button>
                                    <button onclick="rejectAthlete('${u.id}')" class="cyber-button secondary" style="padding:4px 8px; font-size:10px; min-width:auto; border-color:#ff1f3d; color:#ff1f3d;">‚úï</button>
                                </div>
                            </div>`;
                        });
                        html += `<hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 0;">`;
                    }

                    html += `<h3 style="color:#00ff88; margin-bottom:10px; font-size: 14px;">Directorio de Clientes</h3>`;

                    if (activeUsers.length === 0) {
                        html += `<p style="font-size:12px; color:#aaa;">No tienes atletas activos.</p>`;
                    } else {
                        activeUsers.forEach(u => {
                            html += `
                            <div class="liquid-glass card" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:10px; border-left:3px solid #00ff88;">
                                <div>
                                    <strong style="color:white; display:block; font-size: 13px;">${u.fullName || 'Atleta'}</strong>
                                    <span style="font-size:10px; color:#aaa;">ID: ${u.clientIdNum ? '#' + u.clientIdNum : u.id.substring(0, 6).toUpperCase()}</span>
                                </div>
                                <div style="display:flex; gap:5px;">
                                    <button onclick="viewAthleteProfile('${u.id}')" class="cyber-button" style="padding:4px 10px; font-size:10px; min-width:auto;">Ver Perfil</button>
                                    <button onclick="impersonateUser('${u.id}')" class="cyber-button" style="padding:4px 10px; font-size:10px; min-width:auto; background:#ff3333; border-color:#ff3333; color:white;">Vista Coach</button>
                                    <button onclick="window.promptDeleteClient('${u.id}', '${(u.fullName || '').replace(/'/g, "\\'")}')" class="cyber-button secondary" style="padding:4px 10px; font-size:10px; min-width:auto; border-color:#ff1f3d; color:#ff1f3d;" title="Eliminar Cliente">üóëÔ∏è</button>
                                </div>
                            </div>`;
                        });
                    }
                    contentArea.innerHTML = html;
                } else if (tabName === 'rutinas') {
                    window.initRoutineBuilder();

                } else if (tabName === 'planes') {
                    contentArea.innerHTML = `<p style="color:var(--cyber-text-gray); font-size:13px; text-align:center; margin-top:40px;">Construyendo entorno de Planes...</p>`;

                    try {
                        const activeUsers = await AdminController.getClients('approved');
                        const globalRoutines = await AdminController.getGlobalRoutines();

                        let userOptions = activeUsers.map(u => `
                            <label style="display:flex; align-items:center; gap:8px; background:rgba(255,255,255,0.05); padding:8px; border-radius:6px; cursor:pointer;">
                                <input type="checkbox" name="plan-targets" value="${u.id}" class="cyber-checkbox">
                                <span style="color:white; font-size:13px;">${u.fullName || u.email}</span>
                            </label>`).join('');

                        let routineCheckboxes = '';
                        if (globalRoutines.length === 0) {
                            routineCheckboxes = `<p style="color:#ffaa00; font-size:11px;">‚ö†Ô∏è No tienes rutinas creadas. Primero crea rutinas individuales en "Rutinas".</p>`;
                        } else {
                            routineCheckboxes = globalRoutines.map(r => `
                            <label style="display:flex; align-items:center; gap:8px; background:rgba(10,10,10,0.8); border:1px solid #444; padding:10px; border-radius:8px; cursor:pointer;">
                                <input type="checkbox" name="plan-routines" value="${r.name}" data-json='${JSON.stringify(r.exercises || []).replace(/'/g, "&#39;")}' class="cyber-checkbox">
                                <strong style="color:white; font-size:13px;">${r.name}</strong>
                                <span style="font-size:10px; color:#aaa; margin-left:auto;">${(r.exercises || []).length} ejs.</span>
                            </label>`).join('');
                        }

                        let activeRosterHtml = '';
                        if (activeUsers.length === 0) {
                            activeRosterHtml = `<p style="color:#aaa; font-size:12px;">No hay atletas activos.</p>`;
                        } else {
                            activeRosterHtml = `<div style="display:flex; flex-direction:column; gap:10px;">`;
                            activeUsers.forEach(u => {
                                const pName = u.plan && u.plan.name && u.plan.name !== "Sin Plan Activo" ? u.plan.name : "Sin Plan";
                                const isAssigned = pName !== "Sin Plan";

                                activeRosterHtml += `
                                <div class="liquid-glass card" style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-left:3px solid ${isAssigned ? '#00d4ff' : '#444'};">
                                    <div style="flex:1;">
                                        <strong style="color:white; display:block; font-size: 13px;">${u.fullName || u.email}</strong>
                                        <span style="font-size:10px; color:${isAssigned ? '#00d4ff' : '#888'};">Current: ${pName}</span>
                                    </div>
                                    <div style="display:flex; gap:5px;">
                                        ${isAssigned ? `<button onclick="window.confirmUnassignPlan('${u.id}', '${(u.fullName || '').replace(/'/g, "\\'")}')" class="cyber-button secondary" style="padding:4px 10px; font-size:10px; min-width:auto; border-color:#ff1f3d; color:#ff1f3d;" title="Quitar Plan Actual">‚úñÔ∏è Desasignar</button>` : ''}
                                    </div>
                                </div>`;
                            });
                            activeRosterHtml += `</div>`;
                        }

                        contentArea.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h3 style="color:#ff00ff; font-size: 16px; margin:0; text-transform:uppercase;">Constructor de Planes</h3>
                                <button onclick="loadAdminContent('planes')" class="cyber-button secondary" style="min-width:auto; padding:5px 10px; font-size:11px;">‚Üª</button>
                            </div>
                            
                            <div class="liquid-glass" style="padding:15px; margin-bottom:25px;">
                                <label style="font-size:11px; color:#aaa;">1. Nombre del Plan (Ej: Hipertrofia 4 D√≠as):</label>
                                <input type="text" id="builder-plan-name" placeholder="Escribe el nombre del Plan Pack..." class="cyber-input" style="width:100%; padding:12px; margin-top:5px; margin-bottom:15px; background:rgba(0,0,0,0.5); border:1px solid #ff00ff; color:white; border-radius:6px; font-size:14px; outline:none;">
                                
                                <label style="font-size:11px; color:#aaa; margin-bottom:8px; display:block;">2. Elige las Rutinas que conforman este Plan:</label>
                                <div style="display:flex; flex-direction:column; gap:8px; max-height:150px; overflow-y:auto; margin-bottom:15px; padding-right:5px; padding-left:2px;">
                                    ${routineCheckboxes}
                                </div>

                                <label style="font-size:11px; color:#aaa; margin-bottom:8px; display:block;">3. Selecciona a qu√© atletas asignarlo:</label>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; max-height:150px; overflow-y:auto; margin-bottom:15px; padding:5px;">
                                    ${userOptions}
                                </div>
                                
                                <button onclick="window.submitPlanExecution()" class="cyber-button" style="background:linear-gradient(45deg, #ff00ff, #ff1f3d); font-size:13px; letter-spacing:1px; box-shadow:0 0 15px rgba(255,0,255,0.4);">ASIGNAR Y GUARDAR PLAN</button>
                            </div>
                            
                            <h3 style="color:#00d4ff; margin-bottom:15px; font-size: 14px; border-top: 1px solid rgba(255,255,255,0.1); padding-top:15px; text-transform:uppercase;">Atletas Activos (Gestor)</h3>
                            <div style="margin-bottom:25px; max-height: 400px; overflow-y:auto; padding-right:5px;">
                                ${activeRosterHtml}
                            </div>
                        `;
                    } catch (e) {
                        console.error(e);
                        contentArea.innerHTML = `<p style="color:red; font-size:12px;">Error cargando librer√≠a.</p>`;
                    }
                } else if (tabName === 'chat') {
                    try {
                        const clients = await AdminController.getClients();
                        let html = '<h3 style="color:#00d4ff; font-size:16px; margin-bottom:15px;">Inbox Operativo</h3>';
                        if (clients.length === 0) {
                            html += '<p style="color:#aaa; font-size:12px;">No hay clientes en la red.</p>';
                        } else {
                            html += `<div style="display:flex; flex-direction:column; gap:10px;">`;
                            clients.forEach(c => {
                                html += `
                            <div class="liquid-glass card" style="padding:15px; border-left:3px solid #00d4ff; cursor:pointer; transition:0.2s;" onclick="openAdminChat('${c.id}', '${c.fullName || 'Atleta'}')">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <strong style="color:white; font-size:14px; display:flex; align-items:center; gap:8px;">
                                        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="color:#00d4ff;"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg> 
                                        ${c.fullName || 'Atleta'}
                                    </strong>
                                    <span style="font-size:10px; color:#aaa; font-weight:bold;">ID: #${c.clientIdNum ? c.clientIdNum : c.id.substring(0, 4).toUpperCase()}</span>
                                </div>
                            </div>`;
                            });
                            html += `</div>`;
                        }
                        contentArea.innerHTML = html;
                    } catch (error) {
                        console.error(error);
                        contentArea.innerHTML = `<p style="color:red; font-size:12px;">Error al cargar datos del servidor.</p>`;
                    }
                } else if (tabName === 'agenda') {
                    try {
                        const clients = await AdminController.getClients('approved');
                        const agenda = await AdminController.getAgenda();

                        let clientOptions = clients.map(c => `<option value="${c.id}" data-name="${c.fullName || c.email}">${c.fullName || c.email}</option>`).join('');

                        let agendaHtml = '';
                        if (agenda.length === 0) {
                            agendaHtml = `<p style="color:#aaa; font-size:12px; font-style:italic;">No hay citas programadas.</p>`;
                        } else {
                            agenda.forEach(a => {
                                const typeColor = a.type === 'Presencial' ? '#00ff88' : '#00d4ff';
                                agendaHtml += `
                                <div class="liquid-glass card" style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-left:3px solid ${typeColor}; margin-bottom:8px;">
                                    <div>
                                        <div style="font-weight:bold; color:white; font-size:13px;">${a.clientName} <span style="font-size:10px; color:${typeColor}; border:1px solid ${typeColor}; padding:2px 4px; border-radius:3px; margin-left:5px;">${a.type}</span></div>
                                        <div style="font-size:11px; color:#aaa; margin-top:3px;">üìÖ ${a.date} ‚è∞ ${a.time}</div>
                                        ${a.notes ? `<div style="font-size:10px; color:#777; margin-top:3px; font-style:italic;">"${a.notes}"</div>` : ''}
                                    </div>
                                    <button onclick="window.removeAppointment('${a.id}')" class="cyber-button secondary" style="padding:4px; font-size:12px; min-width:auto; border-color:#ff1f3d; color:#ff1f3d;" title="Cancelar Cita">‚úï</button>
                                </div>
                                `;
                            });
                        }

                        contentArea.innerHTML = `
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h3 style="color:#ffcc00; font-size: 14px; margin:0;">Citas Programadas</h3>
                                <button onclick="loadAdminContent('agenda')" class="cyber-button secondary" style="min-width:auto; padding:5px 10px; font-size:11px;">‚Üª</button>
                            </div>
                            
                            <div style="margin-bottom:20px; max-height:200px; overflow-y:auto; padding-right:5px;">
                                ${agendaHtml}
                            </div>
                            
                            <h3 style="color:#00ff88; margin-bottom:15px; font-size: 14px; border-top: 1px solid rgba(255,255,255,0.1); padding-top:15px;">Agendar Nueva Cita</h3>
                            <div style="display:flex; flex-direction:column; gap:8px;">
                                <label style="font-size:11px; color:#aaa;">Atleta:</label>
                                <select id="appt-client" class="cyber-input" style="background:#111; color:white; padding:8px; border:1px solid #444; border-radius:4px;">
                                    ${clientOptions}
                                </select>
                                
                                <div style="display:flex; gap:10px;">
                                    <div style="flex:1;">
                                        <label style="font-size:11px; color:#aaa;">Fecha:</label>
                                        <input type="date" id="appt-date" class="cyber-input" style="width:100%; background:#111; color:white; padding:8px; border:1px solid #444; border-radius:4px;">
                                    </div>
                                    <div style="flex:1;">
                                        <label style="font-size:11px; color:#aaa;">Hora:</label>
                                        <input type="time" id="appt-time" class="cyber-input" style="width:100%; background:#111; color:white; padding:8px; border:1px solid #444; border-radius:4px;">
                                    </div>
                                </div>
                                
                                <label style="font-size:11px; color:#aaa; margin-top:5px;">Modalidad:</label>
                                <select id="appt-type" class="cyber-input" style="background:#111; color:white; padding:8px; border:1px solid #444; border-radius:4px;">
                                    <option value="Online">Videollamada / Online</option>
                                    <option value="Presencial">Presencial / Gimnasio</option>
                                </select>
                                
                                <label style="font-size:11px; color:#aaa; margin-top:5px;">Notas (Opcional):</label>
                                <input type="text" id="appt-notes" placeholder="Ej: Revisi√≥n de t√©cnica de sentadilla" class="cyber-input" style="background:#111; color:white; padding:8px; border:1px solid #444; border-radius:4px;">
                                
                                <button onclick="window.scheduleAppointment()" class="cyber-button" style="margin-top:10px; background:#00ff88; color:black; border:none; font-weight:bold;">Agendar Cita</button>
                            </div>
                            
                            <h3 style="color:#00d4ff; margin-bottom:15px; font-size: 14px; border-top: 1px solid rgba(255,255,255,0.1); padding-top:15px;">Avisos Push (Recordatorios)</h3>
                            <div style="display:flex; flex-direction:column; gap:8px;">
                                <label style="font-size:11px; color:#aaa;">Atleta (Enviar a):</label>
                                <select id="remind-client" class="cyber-input" style="background:#111; color:white; padding:8px; border:1px solid #444; border-radius:4px;">
                                    ${clientOptions}
                                </select>
                                
                                <label style="font-size:11px; color:#aaa; margin-top:5px;">Aviso Directo (Instant√°neo):</label>
                                <div style="display:flex; gap:5px;">
                                    <button onclick="window.sendQuickReminder('fotos')" class="cyber-button secondary" style="flex:1; font-size:10px; padding:8px 4px; border-color:#00d4ff; color:#00d4ff;">üì∏ Subir Fotos</button>
                                    <button onclick="window.sendQuickReminder('peso')" class="cyber-button secondary" style="flex:1; font-size:10px; padding:8px 4px; border-color:#ffaa00; color:#ffaa00;">‚öñÔ∏è Peso B√°scula</button>
                                    <button onclick="window.sendQuickReminder('medidas')" class="cyber-button secondary" style="flex:1; font-size:10px; padding:8px 4px; border-color:#00ff88; color:#00ff88;">üìè Medidas</button>
                                </div>

                                <label style="font-size:11px; color:#aaa; margin-top:10px;">Programar Recordatorio Autom√°tico (App):</label>
                                <div style="display:flex; gap:10px;">
                                    <select id="remind-type" class="cyber-input" style="flex:1; background:#111; color:white; padding:8px; border:1px solid #444; border-radius:4px;">
                                        <option value="fotos">Fotos</option>
                                        <option value="peso">Peso B√°scula</option>
                                        <option value="medidas">Medidas</option>
                                    </select>
                                    <select id="remind-freq" class="cyber-input" style="flex:1; background:#111; color:white; padding:8px; border:1px solid #444; border-radius:4px;">
                                        <option value="7">Semanal (7 d√≠as)</option>
                                        <option value="15">Quincenal (15 d√≠as)</option>
                                        <option value="30">Mensual (30 d√≠as)</option>
                                    </select>
                                </div>
                                <button onclick="window.scheduleReminder()" class="cyber-button" style="margin-top:5px; background:transparent; border:1px solid #00d4ff; color:#00d4ff;">‚öôÔ∏è Programar Push Autom√°tico</button>
                            </div>
                        `;
                    } catch (e) {
                        console.error(e);
                        contentArea.innerHTML = `<p style="color:red; font-size:12px;">Error cargando agenda.</p>`;
                    }
                }
            } catch (error) {
                console.error(error);
                contentArea.innerHTML = `<p style="color:red; font-size:12px;">Error al cargar datos del servidor.</p>`;
            }
        };

        window.scheduleAppointment = async () => {
            const selectEl = document.getElementById('appt-client');
            const uid = selectEl.value;
            const uName = selectEl.options[selectEl.selectedIndex].dataset.name;
            const date = document.getElementById('appt-date').value;
            const time = document.getElementById('appt-time').value;
            const type = document.getElementById('appt-type').value;
            const notes = document.getElementById('appt-notes').value.trim();

            if (!uid || !date || !time) {
                alert("Debes seleccionar atleta, fecha y hora.");
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = "Agendando...";

            const res = await AdminController.createAppointment(uid, uName, date, time, type, notes);
            if (res) {
                showToast("Cita Agendada.");
                window.loadAdminContent('agenda');
            } else {
                alert("Fall√≥ la creaci√≥n de la cita.");
                btn.disabled = false;
                btn.textContent = "Agendar Cita";
            }
        };

        window.sendQuickReminder = async (type) => {
            const uid = document.getElementById('remind-client').value;
            if (!uid) return alert('Selecciona un atleta');

            let txt = "";
            if (type === 'fotos') txt = "üîî RECORDATORIO: Toca actualizaci√≥n de fotos (Frontal/Espalda). S√∫belas en la pesta√±a de Progreso.";
            if (type === 'peso') txt = "üîî RECORDATORIO: Toca actualizaci√≥n de peso en la b√°scula. Reg√≠stralo pulsando el " + " de abajo.";
            if (type === 'medidas') txt = "üîî RECORDATORIO: Toca revisi√≥n de contornos biometr√≠a. Usa el sistema en el bot√≥n flotante " + ".";

            showToast(`Enviando push: ${type}...`);
            const { getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js");
            const userDocRef = doc(db, "users", uid);
            const userSnap = await getDoc(userDocRef);
            if (userSnap.exists()) {
                const uData = userSnap.data();
                const msgs = uData.messages || [];
                msgs.push({
                    sender: 'coach',
                    text: txt,
                    time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    timestamp: Date.now()
                });
                await updateDoc(userDocRef, { messages: msgs });
                showToast("Enviado.");
            }
        };

        window.scheduleReminder = async () => {
            const uid = document.getElementById('remind-client').value;
            const type = document.getElementById('remind-type').value;
            const freq = parseInt(document.getElementById('remind-freq').value, 10);
            if (!uid) return alert('Selecciona atleta');

            let txt = "";
            if (type === 'fotos') txt = "üîî Toca actualizaci√≥n de fotos (Frontal/Espalda).";
            if (type === 'peso') txt = "üîî Toca actualizaci√≥n de peso en la b√°scula.";
            if (type === 'medidas') txt = "üîî Toca revisi√≥n de contornos biometr√≠a.";

            const btn = event.target;
            btn.textContent = "‚öôÔ∏è Programando...";
            btn.disabled = true;

            try {
                const { getDoc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js");
                const userRef = doc(db, "users", uid);
                const snap = await getDoc(userRef);
                if (snap.exists()) {
                    const data = snap.data();
                    const automaticReminders = data.automaticReminders || [];

                    const existingIdx = automaticReminders.findIndex(r => r.type === type);
                    const nextTime = Date.now() + (freq * 24 * 60 * 60 * 1000); // Ms in days

                    if (existingIdx >= 0) {
                        automaticReminders[existingIdx] = { type, text: txt, freqDays: freq, nextTrigger: nextTime };
                    } else {
                        automaticReminders.push({ type, text: txt, freqDays: freq, nextTrigger: nextTime });
                    }

                    await updateDoc(userRef, { automaticReminders });
                    showToast(`Push Autom√°tico (${type}) programado cada ${freq} d√≠as.`);
                }
            } catch (e) {
                console.error(e);
                alert("Error al programar el recordatorio.");
            } finally {
                btn.textContent = "‚öôÔ∏è Programar Push Autom√°tico";
                btn.disabled = false;
            }
        };

        window.removeAppointment = async (id) => {
            if (confirm("¬øCancelar esta cita?")) {
                const res = await AdminController.deleteAppointment(id);
                if (res) {
                    showToast("Cita cancelada.");
                    window.loadAdminContent('agenda');
                } else {
                    alert("No se pudo cancelar la cita.");
                }
            }
        };

        window.promptDeleteClient = async (uid, name) => {
            const check = prompt(`PELIGRO: Est√°s a punto de eliminar a ${name || 'este atleta'} permanentemente.\\nPara confirmar, escribe ELIMINAR en may√∫sculas:`);
            if (check !== 'ELIMINAR') {
                alert("Eliminaci√≥n cancelada.");
                return;
            }
            if (confirm("√öLTIMO AVISO: Se perder√° su cuenta y todo su historial. ¬øProceder?")) {
                showToast("Borrando cuenta permanentemente...");
                const res = await AdminController.deleteClientComplete(uid);
                if (res) {
                    showToast("Cliente eliminado.");
                    window.loadAdminContent('atletas');
                } else {
                    alert("Fall√≥ la eliminaci√≥n.");
                }
            }
        };

        window.promptDeleteGlobalRoutine = async (routineId, name) => {
            if (confirm(`¬øSeguro que deseas eliminar la rutina "${name}" de tu biblioteca plantilla?`)) {
                const res = await AdminController.deleteGlobalRoutine(routineId);
                if (res) {
                    showToast("Rutina borrada de la librer√≠a.");
                    window.loadAdminContent('planes');
                } else {
                    alert("Error eliminando la rutina.");
                }
            }
        };

        // L√ìGICA DEL PLAN BUILDER (ASIGNACI√ìN MULTIPLE)
        window.submitPlanExecution = async () => {
            const planName = document.getElementById('builder-plan-name').value.trim();
            if (!planName) return alert("Por favor, ponle un nombre al Plan (ej: FullBody 3D).");

            const checkedRoutines = Array.from(document.querySelectorAll('input[name="plan-routines"]:checked'));
            if (checkedRoutines.length === 0) return alert("Debes seleccionar al menos 1 rutina para formar el Plan.");

            const checkedTargets = Array.from(document.querySelectorAll('input[name="plan-targets"]:checked'));
            if (checkedTargets.length === 0) return alert("Debes seleccionar a qu√© atletas quieres asignarles este plan.");

            const routinesPayload = checkedRoutines.map(chk => {
                return {
                    routineName: chk.value,
                    exercises: JSON.parse(chk.getAttribute('data-json') || '[]')
                };
            });

            const targetIds = checkedTargets.map(chk => chk.value);

            const btn = event.target;
            btn.textContent = "‚öôÔ∏è Asignando Plan...";
            btn.disabled = true;

            const res = await AdminController.assignPlanToClients(targetIds, planName, routinesPayload);
            if (res) {
                showToast(`Plan "${planName}" asignado a ${targetIds.length} atleta(s).`);
                window.loadAdminContent('planes');
            } else {
                alert("Fallo de red al asignar.");
                btn.textContent = "ASIGNAR Y GUARDAR PLAN";
                btn.disabled = false;
            }
        };

        window.confirmUnassignPlan = async (clientId, clientName) => {
            if (confirm(`¬øDesasignar entrenamiento a ${clientName}? Su panel quedar√° vac√≠o.`)) {
                const res = await AdminController.unassignPlan(clientId);
                if (res) {
                    showToast(`Plan retirado a ${clientName}.`);
                    window.loadAdminContent('planes');
                } else {
                    alert('Error en BBDD local.');
                }
            }
        };

        window.openAdminChat = async (uid, name) => {
            const contentArea = document.getElementById('admin-subcontent');
            contentArea.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <button onclick="loadAdminContent('chat'); if(window.activeChatUnsubscribe) window.activeChatUnsubscribe();" class="cyber-button secondary" style="min-width:auto; padding:5px 10px; font-size:11px;">‚Üê INBOX</button>
                    <h3 style="color:#00d4ff; font-size:16px; margin:0; text-align:right;">${name}</h3>
                </div>
                <div class="liquid-glass card" style="padding:15px; min-height:250px; max-height:400px; overflow-y:auto; margin-bottom:10px; display:flex; flex-direction:column;" id="admin-chat-history-${uid}">
                    <p style="color:var(--cyber-text-gray); font-size:13px; text-align:center; margin-top:40px;">Conectando red cifrada en vivo...</p>
                </div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="reply-input-${uid}" placeholder="Escribe al atleta..." style="flex:1; background:rgba(0,0,0,0.5); border:1px solid #444; color:white; padding:10px; border-radius:4px; font-size:12px;" onkeydown="if(event.key === 'Enter') replyToClient('${uid}')">
                    <button onclick="replyToClient('${uid}')" class="cyber-button" style="padding:10px 15px; font-size:12px; min-width:auto;">Enviar</button>
                </div>
            `;

            try {
                if (window.activeChatUnsubscribe) window.activeChatUnsubscribe();

                const { db, doc, onSnapshot } = await import('./js/firebase.js');
                const docRef = doc(db, "users", uid);

                window.activeChatUnsubscribe = onSnapshot(docRef, (docSnap) => {
                    const box = document.getElementById(`admin-chat-history-${uid}`);
                    if (!box) {
                        window.activeChatUnsubscribe();
                        return;
                    }

                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        const msgs = userData?.messages || [];
                        let msgsHtml = msgs.length === 0 ? `<p style="color:#aaa; font-size:12px; text-align:center; font-style:italic; margin-top:20px;">Sin historial de comunicaciones</p>` : '';

                        msgs.forEach(m => {
                            const align = m.sender === 'coach' ? 'flex-end' : 'flex-start';
                            const bg = m.sender === 'coach' ? 'rgba(0,212,255,0.2)' : 'rgba(255,255,255,0.1)';
                            const color = m.sender === 'coach' ? '#00d4ff' : '#fff';
                            msgsHtml += `<div style="display:flex; flex-direction:column; align-items:${align}; margin-bottom:10px;">
                                            <div style="background:${bg}; color:${color}; padding:8px 12px; border-radius:8px; max-width:80%; font-size:13px;">${m.text}</div>
                                            <span style="font-size:9px; color:#666; margin-top:3px;">${m.time}</span>
                                         </div>`;
                        });

                        const isAtBottom = box.scrollHeight - box.scrollTop <= box.clientHeight + 50;
                        box.innerHTML = msgsHtml;
                        if (isAtBottom) setTimeout(() => box.scrollTop = box.scrollHeight, 50);
                    }
                }, (error) => {
                    console.error("Firebase realtime chat error:", error);
                    const box = document.getElementById(`admin-chat-history-${uid}`);
                    if (box) box.innerHTML = `<p style="color:red; font-size:12px; text-align:center;">Se perdi√≥ la conexi√≥n confidencial.</p>`;
                });
            } catch (e) {
                console.error(e);
                const box = document.getElementById(`admin-chat-history-${uid}`);
                if (box) box.innerHTML = `<p style="color:red; font-size:12px; text-align:center;">Error inicializando socket.</p>`;
            }
        };
        window.approveAthlete = async (uid) => {
            if (!confirm("¬øAprobar a este atleta? Podr√° acceder a la app.")) return;
            showToast("Aprobando...");
            const res = await AdminController.approveUser(uid);
            if (res) { showToast("¬°Atleta Aprobado!"); window.loadAdminTab('solicitudes'); }
            else { alert("Error al aprobar."); }
        };

        window.rejectAthlete = async (uid) => {
            if (!confirm("¬øRechazar a este atleta? Se le denegar√° el acceso permanentemente.")) return;
            showToast("Rechazando...");
            const res = await AdminController.rejectUser(uid);
            if (res) { showToast("Solicitud rechazada"); window.loadAdminTab('solicitudes'); }
            else { alert("Error al rechazar."); }
        };

        window.viewAthleteProfile = async (uid) => {
            const contentArea = document.getElementById('admin-content-area');
            contentArea.innerHTML = `<p style="color:var(--cyber-text-gray); font-size:13px; text-align:center; margin-top:40px;">Cargando datos vit√°les del atleta...</p>`;

            try {
                const userData = await loadUserData(uid);
                if (!userData) {
                    contentArea.innerHTML = `<p style="color:red; font-size:12px; text-align:center;">Atleta no encontrado en registros.</p><button onclick="loadAdminTab('atletas')" class="cyber-button" style="margin-top:15px;">‚Üê Volver</button>`;
                    return;
                }

                const userHistory = await loadHistory(uid);

                let html = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <button onclick="loadAdminTab('atletas')" class="cyber-button secondary" style="min-width:auto; padding:5px 10px; font-size:11px; border-color:#fff; color:#fff;">‚Üê VOLVER</button>
                        <h3 style="color:#00d4ff; font-size:16px;">${userData.fullName || 'Operativo Local'}</h3>
                    </div>
                    
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                        <div class="liquid-glass card" style="padding:10px; border-left:3px solid #ffcc00;">
                            <h4 style="color:#ffcc00; font-size:12px; margin-bottom:5px;">Suscripci√≥n Activa</h4>
                            <p style="font-size:11px; color:white;">${userData.planName || 'Plan Entrenamiento Base'}</p>
                        </div>
                        <div class="liquid-glass card" style="padding:10px; border-left:3px solid #00ff88;">
                            <h4 style="color:#00ff88; font-size:12px; margin-bottom:5px;">Estado F√≠sico</h4>
                            <p style="font-size:11px; color:white; font-weight:bold;">${userData.weight || '--'} kg | ${userData.fat || '--'}% GC</p>
                            <p style="font-size:10px; color:#aaa; margin-top:5px;">Meta: ${userData.objective || 'Mantenimiento'}</p>
                        </div>
                    </div>

                    <h4 style="color:white; font-size:13px; margin-bottom:10px;">Chat Confidencial Directo</h4>
                    <div class="liquid-glass card" style="padding:10px; margin-bottom:15px; border:1px solid rgba(0, 212, 255, 0.3);">
                        <input type="text" id="prof-reply-${uid}" placeholder="Transcripci√≥n de emergencia al comunicador..." autocomplete="off" style="width:100%; padding:10px; background:rgba(0,0,0,0.5); border:1px solid #444; color:white; border-radius:4px; font-size:12px; margin-bottom:10px;">
                        <button onclick="replyToClient('${uid}', 'prof-reply-${uid}')" class="cyber-button" style="padding:8px 15px; font-size:11px; width:100%; background:rgba(0, 212, 255, 0.2); border-color:#00d4ff; color:#00d4ff;">Enviar Comunicado</button>
                    </div>
                    
                    <h4 style="color:white; font-size:13px; margin-bottom:10px;">Telemetr√≠a de Entrenamientos Recientes</h4>
                    <div class="liquid-glass card" style="padding:10px;">
                `;

                if (userHistory.length === 0) {
                    html += `<p style="font-size:11px; color:#aaa;">No se registran datos operativos.</p>`;
                } else {
                    userHistory.slice(0, 5).forEach(workout => {
                        const dateObj = new Date(workout.timestamp);
                        html += `
                        <div style="padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-size:12px; color:white;">${dateObj.toLocaleDateString()}</span>
                            <span style="font-size:12px; padding:2px 8px; border-radius:4px; font-weight:bold; background:rgba(255,31,61,0.2); color:#ff1f3d;">RPE de sesi√≥n: ${workout.rpe || '--'}</span>
                        </div>`;
                    });
                }
                html += `</div>`;

                contentArea.innerHTML = html;
            } catch (err) {
                console.error(err);
                contentArea.innerHTML = `<p style="color:red; font-size:12px;">Error de red cr√≠tico. Abortando lectura.</p><button onclick="loadAdminTab('atletas')" class="cyber-button" style="margin-top:15px;">‚Üê Volver</button>`;
            }
        };

        window.replyToClient = async (clientId, inputId = null) => {
            const input = document.getElementById(inputId || `reply-input-${clientId}`);
            if (!input || input.value.trim() === "") return;

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = "Transmitiendo...";

            const res = await AdminController.replyToMessage(clientId, input.value.trim());
            if (res) {
                showToast("Mensaje enviado exitosamente a red externa");
                input.value = "";
                if (!inputId) {
                    const title = document.querySelector('h3');
                    window.openAdminChat(clientId, title ? title.textContent : 'Atleta');
                }
            } else {
                alert("Error cr√≠tico al enlazar comunicaciones");
            }
            btn.disabled = false;
            btn.textContent = inputId ? "Enviar Comunicado" : "Enviar";
        };

        let adminBackupState = null;
        window.impersonateUser = async (uid) => {
            try {
                showToast("Activando vista Coach...");
                const userData = await loadUserData(uid);
                if (!userData) { alert("Error cargando atleta."); return; }

                // Backup de los datos del admin para poder volver sin recargar
                adminBackupState = JSON.parse(JSON.stringify({
                    profile: State.profile,
                    comparativaImages: State.comparativaImages,
                    history: State.history
                }));

                State.profile.maxWeights = userData.maxWeights || {};
                State.profile.rmRecords = userData.rmRecords || {};
                State.profile.machineNotes = userData.machineNotes || {};
                State.comparativaImages = userData.comparativaImages || {};
                State.profile.id = userData.uid.substring(0, 4).toUpperCase();
                State.profile.name = userData.fullName || 'Atleta';
                State.profile.uid = userData.uid;
                State.profile.weight = userData.weight || '';
                State.profile.fat = userData.fat || '';
                State.profile.clientIdNum = userData.clientIdNum || '??';

                State.history = await loadHistory(uid);

                // Show floating coach banner
                let banner = document.getElementById('coach-mode-banner');
                if (!banner) {
                    banner = document.createElement('div');
                    banner.id = 'coach-mode-banner';
                    document.body.appendChild(banner);
                }
                banner.innerHTML = `
                    <div style="background:#ff3333; color:white; padding:10px; text-align:center; font-weight:bold; position:fixed; top:0; left:0; width:100%; z-index:9999; display:flex; justify-content:space-between; align-items:center;">
                        <span>üëÄ VISTA COACH: ${userData.fullName || 'Atleta'}</span>
                        <button onclick="window.exitCoachMode()" style="background:black; color:white; border:none; padding:5px 10px; border-radius:4px; font-weight:bold; cursor:pointer;">SALIR</button>
                    </div>
                `;
                banner.style.display = 'block';

                navigateTo('progreso');
            } catch (e) {
                console.error(e);
                alert("Fallo al suplantar atleta.");
            }
        };

        window.exitCoachMode = () => {
            if (adminBackupState) {
                State.profile = adminBackupState.profile;
                State.comparativaImages = adminBackupState.comparativaImages;
                State.history = adminBackupState.history;
                adminBackupState = null;
            }
            const banner = document.getElementById('coach-mode-banner');
            if (banner) banner.style.display = 'none';
            navigateTo('admin_dashboard');
        };

        window.addExToRoutine = (exName) => {
            if (!window.adminDraftRoutine) return;
            window.adminDraftRoutine.push({ n: exName, isSuperSet: false });
            window.renderDraftRoutine();
        };

        window.removeExFromRoutine = (idx) => {
            if (!window.adminDraftRoutine) return;
            window.adminDraftRoutine.splice(idx, 1);
            window.renderDraftRoutine();
        };

        window.toggleSuperset = (idx) => {
            if (!window.adminDraftRoutine || idx >= window.adminDraftRoutine.length - 1) return;
            window.adminDraftRoutine[idx].isSuperSet = !window.adminDraftRoutine[idx].isSuperSet;
            window.renderDraftRoutine();
        };

        window.renderDraftRoutine = () => {
            const container = document.getElementById('draft-r-selected');
            if (!container) return;

            if (window.adminDraftRoutine.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = window.adminDraftRoutine.map((ex, idx) => {
                const exData = EXERCISES.find(e => e.n === ex.n) || {};
                const imgPath = typeof exData.img === 'string' ? exData.img : 'logo.png';
                const isLast = idx === window.adminDraftRoutine.length - 1;
                const linkColor = ex.isSuperSet ? '#00ff88' : '#666';

                return `
                <div style="display:flex; align-items:center; gap:10px; padding:10px; background:rgba(30,30,30,0.9); border:1px solid #444; border-radius:6px; margin-bottom:-4px; position:relative;">
                    <button onclick="removeExFromRoutine(${idx})" style="background:none; border:none; color:#ff1f3d; font-size:14px; cursor:pointer; padding:5px;">üóëÔ∏è</button>
                    <img src="${imgPath}" onerror="this.style.display='none'" style="width:30px; height:30px; object-fit:contain; background:transparent; border-radius:4px; padding:2px;">
                    <span style="color:white; font-size:13px; flex:1;">${ex.n}</span>
                    ${!isLast ? `<button onclick="toggleSuperset(${idx})" title="Superserie con el siguiente" style="background:none; border:none; cursor:pointer; padding:5px; font-size:14px; color:${linkColor}; transition:0.2s;">üîó</button>` : ''}
                </div>`;
            }).join('');
        };

        window.filterExercises = () => {
            const val = (document.getElementById('draft-r-search').value || '').toLowerCase();
            const items = document.querySelectorAll('.ex-list-item');
            items.forEach(item => {
                const name = item.dataset.name.toLowerCase();
                item.style.display = name.includes(val) ? 'flex' : 'none';
            });
        };

        window.saveAdminRoutine = async () => {
            const name = document.getElementById('draft-r-name').value.trim();
            if (!name) { alert("Ponle un nombre a la rutina."); return; }
            if (!window.currentRoutineSelections || window.currentRoutineSelections.length === 0) { alert("A√±ade alg√∫n ejercicio primero."); return; }

            const btn = document.querySelector('button[onclick="saveAdminRoutine()"]');
            if (btn) { btn.disabled = true; btn.textContent = "GUARDANDO..."; }

            // Find full exercise data to assign and combine with series/reps/ss definitions
            const routineData = window.currentRoutineSelections.map(s => {
                const found = EXERCISES.find(ex => ex.n === s.n);
                if (found) {
                    return { ...found, id: "ex_" + Math.random().toString(36).substr(2, 9), series_req: s.series, reps_req: s.reps, isSuperSet: s.s };
                } else {
                    return { id: "custom", n: s.n, m: "Varios", eq: "Libre", series_req: s.series, reps_req: s.reps, isSuperSet: s.s };
                }
            });

            const res = await AdminController.saveGlobalRoutine(name, routineData);
            if (res) {
                showToast("Rutina guardada en la base global.");
                window.loadAdminContent('planes'); // redirigir a los planes/librer√≠a para verla
            } else {
                alert("Error al guardar la rutina.");
                if (btn) { btn.disabled = false; btn.textContent = "GUARDAR RUTINA"; }
            }
        };

        window.submitCustomRoutine = async () => {
            const uid = document.getElementById('admin-routine-user').value;
            const rName = document.getElementById('admin-routine-name').value.trim();

            if (!uid || !rName) {
                alert("Rellena todos los campos.");
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.textContent = "Asignando...";

            // Para que este demo funcione, asiganamos un array dummy o buscamos de Firestore
            // Asumiremos que el app lo generar√° con un array por ahora.
            const dummyExercises = [EXERCISES[0], EXERCISES[1]];

            const res = await AdminController.assignRoutineToUser(uid, rName, dummyExercises);
            if (res) {
                showToast("Plan asignado exitosamente.");
                document.getElementById('admin-routine-name').value = '';
            } else {
                alert("Error asignando rutina.");
            }
            btn.disabled = false;
            btn.textContent = "Asignar Plan / Rutina";
        };

        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast-msg'; t.innerHTML = msg;
            container.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 500); }, 4000);
        }

        function getWeekDays() {
            let curr = new Date(); let week = [];
            let first = curr.getDate() - curr.getDay() + (curr.getDay() === 0 ? -6 : 1);
            let monday = new Date(curr.setDate(first));
            for (let i = 0; i < 7; i++) { let d = new Date(monday); d.setDate(monday.getDate() + i); week.push(d); }
            return week;
        }
        const daysNames = ['DOM.', 'LUN.', 'MAR.', 'MI√â.', 'JUE.', 'VIE.', 'S√ÅB.'];
        const formatYMD = (date) => { const offset = date.getTimezoneOffset() * 60000; return (new Date(date - offset)).toISOString().split('T')[0]; };

        // ==========================================
        // MOTOR GR√ÅFICO: ESC√ÅNER ANAT√ìMICO (HUD TELEMETR√çA)
        // ==========================================
        function renderHUDMap(containerId, activeMuscles) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Si el contenedor es el de progreso global o el del workout
            const isGlobal = containerId === 'global-muscle-map';
            const chartKey = isGlobal ? 'radarProgress' : 'radarWorkout';
            const canvasId = `chart-${containerId}`;

            // 1. Limpiar e inyectar Canvas
            container.innerHTML = `
                <div style="position: relative; width: 100%; height: 280px; padding: 10px;">
                    <canvas id="${canvasId}"></canvas>
                </div>
            `;

            // Vol√∫menes m√°ximos √≥ptimos aproximados (semanales o sesi√≥n intensa) para normalizar al 100%
            // Si se pasa de este valor, el gr√°fico se llenar√° por encima del 100% (sobreentrenamiento)
            const MAX_VOLUMES = {
                'Cu√°driceps': 20,
                'Isquios': 16,
                'Gl√∫teos': 16,
                'Pecho': 18,
                'Espalda': 20,
                'Hombros': 18,
                'B√≠ceps': 12,
                'Tr√≠ceps': 12,
                'Gemelos': 14,
                'Abs': 10
            };

            const labels = [];
            const dataSets = [];
            const rawData = []; // Para el tooltip

            // 2. Preparar Datos (Normalizaci√≥n)
            for (let m in activeMuscles) {
                const count = activeMuscles[m];
                if (count > 0 && MAX_VOLUMES[m]) {
                    labels.push(m);
                    const percentage = Math.round((count / MAX_VOLUMES[m]) * 100);
                    dataSets.push(percentage);
                    rawData.push({ muscle: m, sets: count, max: MAX_VOLUMES[m] });
                }
            }

            // Si no hay datos, mostrar mensaje
            if (labels.length === 0) {
                container.innerHTML = `<p style="text-align:center; color:var(--cyber-text-gray); font-size:12px; padding:20px;">Sin telemetr√≠a muscular registrada.</p>`;
                return;
            }

            // 3. Renderizar Chart.js Radar
            if (typeof Chart === 'undefined') { setTimeout(() => renderHUDMap(containerId, activeMuscles), 500); return; }

            if (State.charts[chartKey]) State.charts[chartKey].destroy();

            const ctx = document.getElementById(canvasId).getContext('2d');

            State.charts[chartKey] = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Desgaste / Volumen',
                        data: dataSets,
                        backgroundColor: 'rgba(255, 31, 61, 0.3)', // Cyber Red Neon (Dim)
                        borderColor: '#ff1f3d', // Solid Neon Red
                        borderWidth: 2,
                        pointBackgroundColor: '#00ff88', // Neo Green points
                        pointBorderColor: '#000',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#ff1f3d',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(10, 10, 10, 0.95)',
                            titleColor: '#00ff88',
                            bodyColor: '#fff',
                            borderColor: '#ff1f3d',
                            borderWidth: 1,
                            callbacks: {
                                label: function (context) {
                                    const raw = rawData[context.dataIndex];
                                    return `Series Reales: ${raw.sets} / M√°x. Rec: ${raw.max}`;
                                },
                                afterLabel: function (context) {
                                    return `Carga Relativa: ${context.raw}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.2)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)', circular: true },
                            pointLabels: {
                                color: '#a0a0a0', // Cyber-text-gray
                                font: { size: 10, family: 'monospace', weight: 'bold' }
                            },
                            ticks: {
                                display: false, // Ocultar n√∫meros del eje
                                min: 0,
                                suggestedMax: 100 // El radar va hasta el 100% ideal
                            }
                        }
                    }
                }
            });
        }

        // AUDIO
        function initAudioEngine() {
            if (!State.audioCtx) { const AudioContext = window.AudioContext || window.webkitAudioContext; State.audioCtx = new AudioContext(); }
            if (State.audioCtx.state === 'suspended') State.audioCtx.resume();
        }
        function playTickSound(isFinal = false) {
            if (!State.audioCtx) return;
            if (State.audioCtx.state === 'suspended') State.audioCtx.resume();
            const osc = State.audioCtx.createOscillator(); const gain = State.audioCtx.createGain();
            osc.connect(gain); gain.connect(State.audioCtx.destination);
            const now = State.audioCtx.currentTime;
            if (isFinal) {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(880, now);
                gain.gain.setValueAtTime(1.0, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 1.0);
                osc.start(now); osc.stop(now + 1.0);
                if ("vibrate" in navigator) navigator.vibrate([300, 100, 300]);
            } else {
                osc.type = 'sine'; osc.frequency.setValueAtTime(1000, now);
                gain.gain.setValueAtTime(0.8, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
                osc.start(now); osc.stop(now + 0.1);
            }
        }

        // ==========================================
        // ESTADO GLOBAL DE LA APP 
        // ==========================================
        const State = {
            currentView: '', routine: [], activeWorkout: null, currentExerciseIndex: 0,
            restTimeLeft: 0, timerInt: null, audioCtx: null, lastBeepSecond: -1,
            comparativaAngle: 'frontal', charts: { bio: null, measure: null, progress: null, radarProgress: null, radarWorkout: null },
            profile: {
                id: '24', name: 'Antoni Lafuente', dob: '1990-05-15', gender: 'masculino',
                objective: 'volumen', restTimerDefault: 60, weight: '', height: '', fat: '', muscle: '',
                clientIdNum: '??',
                machineNotes: {}, maxWeights: {}, measurements: {}
            },
            plan: {
                activeDate: formatYMD(new Date()), routinesAvailable: ['Rutina de Empuje', 'Rutina de Tir√≥n', 'Piernas Completas'],
                events: { [formatYMD(new Date())]: [{ title: 'Cita Coach Admin', time: '18:00h', type: 'visit' }] }
            },
            messages: [{ sender: 'coach', text: "¬°Hola! ¬øC√≥mo llevamos el volumen?", time: "10:30" }]
        };

        const DOM = { view: document.getElementById('app-view'), navItems: document.querySelectorAll('.nav-item') };

        function generateAIRoutine(target, level, time) {
            const muscleMap = { 'pecho': ['Pecho'], 'espalda': ['Espalda'], 'piernas': ['Cu√°driceps', 'Isquios', 'Gl√∫teos', 'Gemelos'], 'brazos': ['B√≠ceps', 'Tr√≠ceps'], 'fullbody': ['Pecho', 'Espalda', 'Cu√°driceps', 'Hombros'] };
            const targetMuscles = muscleMap[target] || ['Pecho'];
            let available = EXERCISES.filter(ex => targetMuscles.includes(ex.m));
            const shuffle = (arr) => arr.sort(() => 0.5 - Math.random());
            available = shuffle(available);
            let limit = time === '30' ? 3 : time === '45' ? 5 : 7;
            let compounds = available.filter(ex => ex.t === 'c');
            let isolated = available.filter(ex => ex.t === 'i');
            let result = [];
            if (level === 'avanzado') result = [...compounds.slice(0, Math.ceil(limit * 0.7)), ...isolated.slice(0, Math.floor(limit * 0.3))];
            else result = [...compounds.slice(0, Math.floor(limit * 0.4)), ...isolated.slice(0, Math.ceil(limit * 0.6))];
            if (result.length < limit) result = available.slice(0, limit);
            return shuffle(result);
        }

        // ==========================================
        // RENDERIZADO DE VISTAS (100% COMPLETAS)
        // ==========================================
        const Views = {
            menu: () => `
                <h2 style="margin-bottom: 15px; position:relative;">
                    Panel de Control
                    ${State.profile.role === 'admin' ? '<span class="view-trigger" data-target="admin_dashboard" style="position:absolute; right:0; top:0; color:#ffcc00; cursor:pointer;" title="Panel Coach/Admin"><svg class="cyber-icon" viewBox="0 0 24 24" style="color:#ffcc00; width:28px; height:28px;"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/></svg></span>' : ''}
                </h2>
                <div class="menu-grid">
                    <div class="liquid-glass menu-item view-trigger" data-target="perfil"><div class="menu-icon"><svg class="cyber-icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div><span>Mi Perfil</span></div>
                    <div class="liquid-glass menu-item view-trigger" data-target="estado_fisico"><div class="menu-icon"><svg class="cyber-icon" viewBox="0 0 24 24"><path d="M16 6l-3.5 10.5-2.5-7.5H4v2h4.5l2.5 7.5 3.5-10.5 1.5 4.5H20v-2h-2.5z"/></svg></div><span>Estado F√≠sico</span></div>
                    <div class="liquid-glass menu-item view-trigger" data-target="suscripcion"><div class="menu-icon"><svg class="cyber-icon" viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg></div><span>Suscripci√≥n</span></div>
                    <div class="liquid-glass menu-item view-trigger" data-target="alertas"><div class="menu-icon"><svg class="cyber-icon" viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg></div><span>Alertas</span></div>
                    <div class="liquid-glass menu-item view-trigger" data-target="historial"><div class="menu-icon"><svg class="cyber-icon" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg></div><span>Historial</span></div>
                    <div class="liquid-glass menu-item view-trigger" data-target="comparativa"><div class="menu-icon"><svg class="cyber-icon" viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg></div><span>Comparativa</span></div>
                </div>
                <button class="info-btn-thin view-trigger" data-target="faq"><svg class="cyber-icon" viewBox="0 0 24 24"><path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"/></svg> FAQ (Dudas)</button>
                <button class="logout-btn-thin" id="btn-logout"><svg class="cyber-icon" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg> Desconectar Sistema</button>
            `,

            instrucciones: () => `
                <h2 style="margin-bottom: 15px; display:flex; gap:10px; align-items:center;"><span class="view-trigger" data-target="menu" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> Manual Operativo</h2>
                <div class="liquid-glass card">
                    <div class="guide-block"><h4><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 002 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10z"/></svg> 1. Plan Semanal</h4>Tu pantalla base. Aqu√≠ ves tu calendario, citas con el Coach y las rutinas pendientes. Toca "INICIAR" en una rutina para entrenar.</div>
                    <div class="guide-block"><h4><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> 2. Bot√≥n (+) R√°pido</h4>P√∫lsalo en el gimnasio para anotar al vuelo tu peso, % grasa, pliegues o un Cheat Meal sin perder tu sesi√≥n activa.</div>
                    <div class="guide-block"><h4><svg viewBox="0 0 24 24"><path d="M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22 14.86 20.57 17 22.71 22.71 17z"/></svg> 3. Dropset y Marcar Todo</h4>En el entreno, usa "‚úì Todo" si vas r√°pido. Si fallas una serie, pulsa la gota "üíß", el sistema leer√° lo que acabas de hacer, cerrar√° la serie y crear√° una descendente restando un 32% al peso y sum√°ndole 4 reps a las que te quedaban.</div>
                    <div class="guide-block"><h4><svg viewBox="0 0 24 24"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg> 4. Progreso y Comparativa</h4>Ve tus gr√°ficas y HUD Muscular en "Progreso". Para ver tu cambio f√≠sico, ve al Men√∫ -> "Comparativa" y sube fotos para usar el slider.</div>
                </div>
            `,

            faq: () => `
                <h2 style="margin-bottom: 15px; display:flex; gap:10px; align-items:center;"><span class="view-trigger" data-target="menu" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> FAQ</h2>
                <div class="liquid-glass card">
                    <div class="guide-block"><h4>¬øQu√© significa la gota üíß?</h4>Es el bot√≥n de <b>Dropset</b>. P√∫lsalo despu√©s de anotar tu peso y repeticiones reales. Si tocaba hacer 16 reps y solo haces 12 con 20kg, al dar a la gota el sistema crear√° una serie extra al momento pidi√©ndote 8 reps (las 4 que faltan + 4) con 14kg (-32%).</div>
                    <div class="guide-block"><h4>¬øQu√© es el RPE al finalizar?</h4>Significa "Esfuerzo Percibido". <br>üü¢ Suave: Pod√≠as hacer m√°s repeticiones.<br>üü† Duro: Te cost√≥ terminar, quiz√° pod√≠as hacer 1 m√°s.<br>üî¥ Fallo: Imposible hacer ni una repetici√≥n m√°s.</div>
                    <div class="guide-block"><h4>¬øC√≥mo funciona la IA?</h4>Lee tu Peso, Altura, Edad y G√©nero para estructurar un entrenamiento perfecto al instante bas√°ndose en tu nivel y el tiempo que tengas disponible.</div>
                    <div class="guide-block"><h4>¬øC√≥mo cambio de m√°quina?</h4>Si la m√°quina est√° ocupada, pulsa "üîÅ Cambiar M√°quina" dentro del ejercicio activo. Se abrir√° una lista manual de opciones del mismo grupo muscular.</div>
                </div>
            `,

            perfil: () => {
                const initialAge = calculateAge(State.profile.dob);
                return `
                <h2 style="margin-bottom: 15px; display:flex; gap:10px; align-items:center;"><span class="view-trigger" data-target="menu" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> Mi Perfil</h2>
                <div class="liquid-glass card auth-form">
                    <p style="color:var(--cyber-text-gray); font-size:12px;">C√≥digo Operativo: <strong style="color:white;">#${State.profile.clientIdNum || State.profile.id}</strong></p>
                    <label style="font-size:12px; color:var(--cyber-red-neon);">Correo Electr√≥nico</label><input type="email" value="operativo@fitdata.pro" disabled>
                    <label style="font-size:12px; color:var(--cyber-red-neon);">Nombre Completo</label><input type="text" id="prof-name" value="${State.profile.name}">
                    <label style="font-size:12px; color:var(--cyber-red-neon); display:flex; justify-content:space-between;">Fecha Nacimiento <span id="age-display" style="color:var(--cyber-white); font-weight:bold;">${initialAge ? `(${initialAge} a√±os)` : ''}</span></label>
                    <input type="date" id="prof-dob" value="${State.profile.dob}">
                    <label style="font-size:12px; color:var(--cyber-red-neon);">Usuario Telegram</label><div style="position: relative;"><input type="text" value="antoni_fit" style="padding-left: 40px;"><span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--cyber-red-neon);">@</span></div>
                    <label style="font-size:12px; color:var(--cyber-red-neon);">Perfil Instagram</label><div style="position: relative;"><input type="text" placeholder="usuario_ig" style="padding-left: 40px;"><span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--cyber-red-neon);">@</span></div>
                    <button class="cyber-button" style="margin-top: 10px;" id="btn-save-profile">Actualizar Datos</button>
                </div>`;
            },

            estado_fisico: () => `
                <h2 style="margin-bottom: 15px; display:flex; gap:10px; align-items:center;"><span class="view-trigger" data-target="menu" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> Estado F√≠sico</h2>
                <div class="liquid-glass card auth-form">
                    
                    <h3 style="color:var(--cyber-white); font-size:16px;">M√©tricas Base</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div><label style="font-size:12px; color:var(--cyber-red-neon);">Peso (kg)</label><input type="number" id="bio-weight" value="${State.profile.weight}"></div>
                        <div><label style="font-size:12px; color:var(--cyber-red-neon);">Altura (cm)</label><input type="number" id="bio-height" value="${State.profile.height}"></div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div><label style="font-size:12px; color:var(--cyber-red-neon);">% Grasa</label><input type="number" id="bio-fat" value="${State.profile.fat}" placeholder="Auto-JP7"></div>
                        <div><label style="font-size:12px; color:var(--cyber-text-gray);">% M√∫sculo (Opcional)</label><input type="number" id="bio-muscle" value="${State.profile.muscle}"></div>
                    </div>
                    
                    <div class="collapsible-container">
                        <div class="collapsible-header" id="btn-toggle-jp7"><span>Pliegues Avanzados (JP7)</span><span id="jp7-arrow" style="color:var(--cyber-red-neon);">‚ñº</span></div>
                        <div id="jp7-content" class="collapsible-content hidden">
                            <p style="font-size:11px; color:var(--cyber-text-gray); margin-bottom:15px;">Al rellenar los 7, se calcular√° el % Grasa autom√°ticamente.</p>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                <div><label style="font-size:11px; color:white;">Pecho</label><input type="number" class="jp7-input" placeholder="0" style="min-height:35px; padding:5px;"></div>
                                <div><label style="font-size:11px; color:white;">Abdomen</label><input type="number" class="jp7-input" placeholder="0" style="min-height:35px; padding:5px;"></div>
                                <div><label style="font-size:11px; color:white;">Muslo</label><input type="number" class="jp7-input" placeholder="0" style="min-height:35px; padding:5px;"></div>
                                <div><label style="font-size:11px; color:white;">Tr√≠ceps</label><input type="number" class="jp7-input" placeholder="0" style="min-height:35px; padding:5px;"></div>
                                <div><label style="font-size:11px; color:white;">Subesc.</label><input type="number" class="jp7-input" placeholder="0" style="min-height:35px; padding:5px;"></div>
                                <div><label style="font-size:11px; color:white;">Suprail.</label><input type="number" class="jp7-input" placeholder="0" style="min-height:35px; padding:5px;"></div>
                                <div style="grid-column: span 2;"><label style="font-size:11px; color:white;">Axilar Medio</label><input type="number" class="jp7-input" placeholder="0" style="min-height:35px; padding:5px;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="collapsible-container">
                        <div class="collapsible-header" id="btn-toggle-perimeters"><span>Per√≠metros Corporales (cm)</span><span id="perim-arrow" style="color:var(--cyber-red-neon);">‚ñº</span></div>
                        <div id="perim-content" class="collapsible-content hidden">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                <div><label style="font-size:11px; color:white;">Hombros</label><input type="number" id="perim-hombros" placeholder="0" style="min-height:35px; padding:5px;"></div>
                                <div><label style="font-size:11px; color:white;">Pecho</label><input type="number" id="perim-pecho" placeholder="0" style="min-height:35px; padding:5px;"></div>
                                <div><label style="font-size:11px; color:white;">Brazo</label><input type="number" id="perim-brazo" placeholder="0" style="min-height:35px; padding:5px;"></div>
                                <div><label style="font-size:11px; color:white;">Cintura</label><input type="number" id="perim-cintura" placeholder="0" style="min-height:35px; padding:5px;"></div>
                                <div><label style="font-size:11px; color:white;">Abdomen</label><input type="number" id="perim-abdomen" placeholder="0" style="min-height:35px; padding:5px;"></div>
                                <div><label style="font-size:11px; color:white;">Cadera</label><input type="number" id="perim-cadera" placeholder="0" style="min-height:35px; padding:5px;"></div>
                                <div style="grid-column: span 2;"><label style="font-size:11px; color:white;">Muslo</label><input type="number" id="perim-muslo" placeholder="0" style="min-height:35px; padding:5px;"></div>
                            </div>
                        </div>
                    </div>

                    <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:15px 0;">

                    <h3 style="color:var(--cyber-white); font-size:16px;">Par√°metros Deportivos</h3>
                    <label style="font-size:12px; color:var(--cyber-red-neon);">Objetivo Principal</label>
                    <div class="select-wrapper">
                        <select id="bio-obj">
                            <option value="salud" ${State.profile.objective === 'salud' ? 'selected' : ''}>Mantenimiento / Salud</option>
                            <option value="deficit" ${State.profile.objective === 'deficit' ? 'selected' : ''}>D√©ficit (P√©rdida de Grasa)</option>
                            <option value="volumen" ${State.profile.objective === 'volumen' ? 'selected' : ''}>Volumen (Hipertrofia)</option>
                            <option value="fuerza" ${State.profile.objective === 'fuerza' ? 'selected' : ''}>Fuerza M√°xima</option>
                            <option value="resistencia" ${State.profile.objective === 'resistencia' ? 'selected' : ''}>Resistencia / Cardio</option>
                        </select>
                    </div>
                    <label style="font-size:12px; color:var(--cyber-red-neon);">Descanso entre Series (seg)</label>
                    <input type="number" id="bio-rest" value="${State.profile.restTimerDefault}">

                    <button class="cyber-button" style="margin-top: 15px;" id="btn-save-bio">Guardar Biometr√≠a</button>
                </div>
            `,
            log_comida: () => `<h2 style="margin-bottom: 15px; display:flex; gap:10px; align-items:center;"><span class="view-trigger" data-target="plan" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> A√±adir Comida</h2><div class="liquid-glass card auth-form"><label style="font-size:12px; color:var(--cyber-red-neon);">Tipo</label><div class="select-wrapper"><select><option value="cheat">Cheat Meal (Fuera de Dieta)</option><option value="extra">Comida Extra</option></select></div><label style="font-size:12px; color:var(--cyber-red-neon);">Descripci√≥n</label><input type="text" placeholder="Ej: Pizza doble"><button class="cyber-button" style="margin-top:20px;" id="btn-save-meal">Registrar</button></div>`,

            suscripcion: () => `
                <h2 style="margin-bottom: 15px; display:flex; gap:10px; align-items:center;"><span class="view-trigger" data-target="menu" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> Suscripci√≥n</h2>
                <h3 style="color:var(--cyber-white); font-size:16px; margin-bottom:10px;">Seleccionar Plan Activo</h3>
                
                <input type="radio" name="plan" id="plan-app" class="plan-card-input" value="Plan APP (29‚Ç¨)">
                <label for="plan-app" class="plan-card-label"><span style="font-weight:bold; font-size:16px;">Plan APP</span><br><span style="color:var(--cyber-text-gray);">29‚Ç¨ / mes</span></label>

                <input type="radio" name="plan" id="plan-prep" class="plan-card-input" value="Plan Preparaci√≥n (70‚Ç¨)" checked>
                <label for="plan-prep" class="plan-card-label"><span class="recommended-badge">RECOMENDADO</span><span style="font-weight:bold; font-size:16px;">Plan Preparaci√≥n</span><br><span style="text-decoration:line-through; color:#666; font-size:12px;">95‚Ç¨</span> <span style="color:var(--cyber-red-neon); font-size:18px; font-weight:bold;">70‚Ç¨ / mes</span></label>

                <input type="radio" name="plan" id="plan-4ses" class="plan-card-input" value="4 Sesiones Personales (170‚Ç¨)">
                <label for="plan-4ses" class="plan-card-label"><span style="font-weight:bold; font-size:16px;">4 Sesiones Personales</span><br><span style="color:var(--cyber-text-gray);">170‚Ç¨ / mes</span></label>

                <input type="radio" name="plan" id="plan-8ses" class="plan-card-input" value="8 Sesiones Personales (290‚Ç¨)">
                <label for="plan-8ses" class="plan-card-label"><span style="font-weight:bold; font-size:16px;">8 Sesiones Personales</span><br><span style="color:var(--cyber-text-gray);">290‚Ç¨ / mes</span></label>

                <input type="radio" name="plan" id="plan-suelta" class="plan-card-input" value="Sesi√≥n Suelta (45‚Ç¨)">
                <label for="plan-suelta" class="plan-card-label"><span style="font-weight:bold; font-size:16px;">Sesi√≥n de Entreno Suelta</span><br><span style="color:var(--cyber-text-gray);">45‚Ç¨ <span style="font-size:11px;">(1ra vez 40‚Ç¨)</span></span></label>

                <button class="cyber-button" id="btn-pay-plan" style="margin-top:10px;">Proceder al Pago Seguro</button>

                <h3 style="margin-top:25px; font-size:16px;">Historial de Transacciones</h3>
                <div class="liquid-glass" style="margin-top:10px;">
                    <div class="list-item"><div style="display:flex; flex-direction:column;"><span style="font-weight:bold;">Plan Preparaci√≥n</span><span style="font-size:11px; color:var(--cyber-text-gray);">15 Sep 2026</span></div><span style="color:var(--cyber-red-neon); font-weight:bold;">70.00‚Ç¨</span></div>
                </div>
            `,

            historial: () => {
                let html = `
                <h2 style="margin-bottom: 15px; display:flex; gap:10px; align-items:center;"><span class="view-trigger" data-target="menu" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> Historial</h2>
                <div class="liquid-glass card">
                    <h3 style="color:var(--cyber-red-neon); font-size:14px; margin-bottom:15px; text-transform:uppercase;">Registros Completados</h3>
                `;

                if (!State.history || State.history.length === 0) {
                    html += `<p style="color:var(--cyber-text-gray); font-size:12px; text-align:center; padding: 20px 0;">No hay entrenamientos guardados.</p>`;
                } else {
                    State.history.forEach(workout => {
                        const dateObj = new Date(workout.timestamp);
                        const dateStr = dateObj.toLocaleDateString();

                        let rpeClass = 'rpe-optimo';
                        if (workout.rpe >= 9) rpeClass = 'rpe-fallo';
                        else if (workout.rpe >= 7) rpeClass = 'rpe-duro';

                        let title = 'Entrenamiento';
                        if (workout.exercises && workout.exercises.length > 0) {
                            title = workout.exercises[0].name.split(' ')[0] + ' + Otros';
                        }
                        const totalSets = workout.totalSets || 0;

                        html += `
                        <div class="list-item" style="padding: 10px 0;">
                            <div style="display:flex; flex-direction:column;">
                                <span style="font-weight:bold; font-size:14px;">${title}</span>
                                <span style="font-size:11px; color:var(--cyber-text-gray);">${dateStr} ‚Ä¢ ${totalSets} series <span class="rpe-dot ${rpeClass}"></span></span>
                            </div>
                        </div>`;
                    });
                }
                html += `</div>`;
                return html;
            },

            comparativa: () => {
                const angle = State.comparativaAngle || 'frontal';
                const keyInicio = `inicio_${angle}`;
                const keyActual = `actual_${angle}`;

                const imgInicio = (State.comparativaImages && State.comparativaImages[keyInicio]) ? State.comparativaImages[keyInicio] : "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='400' height='600' viewBox='0 0 400 600'><rect width='400' height='600' fill='%23222222'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23ff1f3d' font-family='sans-serif' font-size='24'>FOTO INICIO</text></svg>";
                const imgActual = (State.comparativaImages && State.comparativaImages[keyActual]) ? State.comparativaImages[keyActual] : "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='400' height='600' viewBox='0 0 400 600'><rect width='400' height='600' fill='%23111111'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%2300ff88' font-family='sans-serif' font-size='24'>FOTO ACTUAL</text></svg>";

                return `
                <h2 style="margin-bottom: 15px; display:flex; gap:10px; align-items:center;"><span class="view-trigger" data-target="menu" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> Comparativa</h2>
                <div class="liquid-glass card">
                    <p style="color:var(--cyber-text-gray); font-size:12px; margin-bottom:10px;">Selecciona fechas y √°ngulo para comparar.</p>
                    
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div class="select-wrapper" style="flex:1;">
                            <select id="comp-date-1" style="font-size:12px; padding:8px; min-height:40px;">
                                <option value="Inicio (Ene 2026)">Inicio (Ene)</option>
                                <option value="Feb 2026">Feb 2026</option>
                            </select>
                        </div>
                        <div class="select-wrapper" style="flex:1;">
                            <select id="comp-date-2" style="font-size:12px; padding:8px; min-height:40px;">
                                <option value="Mar 2026">Mar 2026</option>
                                <option value="Actual (Hoy)" selected>Actual (Hoy)</option>
                            </select>
                        </div>
                    </div>

                    <div class="angle-tabs">
                        <div class="angle-btn ${State.comparativaAngle === 'frontal' ? 'active' : ''}" data-angle="frontal">Frontal</div>
                        <div class="angle-btn ${State.comparativaAngle === 'espalda' ? 'active' : ''}" data-angle="espalda">Espalda</div>
                        <div class="angle-btn ${State.comparativaAngle === 'izq' ? 'active' : ''}" data-angle="izq">L. Izq</div>
                        <div class="angle-btn ${State.comparativaAngle === 'der' ? 'active' : ''}" data-angle="der">L. Der</div>
                    </div>
                    
                    <div class="slider-container">
                        <img src="${imgActual}" class="slider-img after">
                        <img src="${imgInicio}" class="slider-img before" id="img-before">
                        
                        <div class="slider-label label-before" id="label-img-1">INICIO (ENE)</div>
                        <div class="slider-label label-after" id="label-img-2">ACTUAL (HOY)</div>
                        
                        <input type="range" min="0" max="100" value="0" class="slider-range" id="photo-slider">
                        <div class="slider-line" id="slider-line" style="left: 0%;"><div class="slider-thumb">‚óÑ‚ñ∫</div></div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; margin-top:15px; gap:10px;">
                        <label class="cyber-button secondary" style="flex:1; font-size:11px; text-align:center; cursor:pointer;" for="upload-inicio">
                            Subir Foto 1
                            <input type="file" id="upload-inicio" accept="image/*" style="display:none;">
                        </label>
                        <label class="cyber-button secondary" style="flex:1; font-size:11px; border-color:#00ff88; color:#00ff88; text-align:center; cursor:pointer;" for="upload-actual">
                            Subir Foto 2
                            <input type="file" id="upload-actual" accept="image/*" style="display:none;">
                        </label>
                    </div>
                </div>
            `;
            },

            alertas: () => `<h2 style="margin-bottom: 15px; display:flex; gap:10px; align-items:center;"><span class="view-trigger" data-target="menu" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> Notificaciones</h2><div class="liquid-glass"><div class="list-item" style="background: rgba(255, 31, 61, 0.1);"><div style="display:flex; flex-direction:column;"><span style="font-weight:bold; color:var(--cyber-white);">Sistema FitDataPro</span><span style="font-size:12px; color:var(--cyber-text-gray);">Actualiza tus datos biom√©tricos para activar la IA.</span></div></div></div>`,

            plan: () => {
                const weekDays = getWeekDays(); let calendarHtml = '';
                weekDays.forEach(date => {
                    const ymd = formatYMD(date); const isActive = ymd === State.plan.activeDate; const dayName = daysNames[date.getDay()]; const dayNum = date.getDate();
                    calendarHtml += `<div class="cal-day ${isActive ? 'active' : ''}" data-date="${ymd}"><span>${dayName}</span><span>${dayNum}</span></div>`;
                });

                const todaysEvents = State.plan.events[State.plan.activeDate] || [];
                let eventsHtml = todaysEvents.length === 0 ? `<div class="liquid-glass" style="padding:15px; color:var(--cyber-text-gray); font-style:italic; font-size:14px; margin-bottom:20px;">Sin eventos programados.</div>` : '';
                todaysEvents.forEach(ev => eventsHtml += `<div class="liquid-glass card" style="border-left: 4px solid #ffcc00; margin-bottom:20px; padding:15px;"><div class="card-title" style="color:#ffcc00;"><svg class="cyber-icon" style="width:16px; height:16px;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg> ${ev.title}</div><p style="color:white; font-size:16px;">${ev.time}</p></div>`);

                let routinesHtml = State.plan.routinesAvailable.length === 0 ? `<div class="liquid-glass" style="padding:15px; color:var(--cyber-text-gray); font-style:italic; font-size:14px;">Actualmente no tienes un Entrenamientos asignado. Habla con tu Coach.</div>` : '';

                State.plan.routinesAvailable.forEach((r, index) => {
                    routinesHtml += `
                    <div class="liquid-glass card" style="padding:15px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:bold; color:white;">${r.routineName || 'Rutina Desconocida'}</span>
                        <button class="cyber-button secondary" onclick="window.startAssignedRoutine(${index})" style="min-height:35px; width:auto; padding:0 15px; font-size:12px;">INICIAR</button>
                    </div>`;
                });

                return `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;"><h2 style="font-size:18px;">Mis actividades</h2></div>
                    <div class="calendar-scroller">${calendarHtml}</div>
                    ${eventsHtml}
                    <h2 style="font-size:18px; margin-bottom:10px; margin-top:10px;">${State.plan.name || 'Plan Local'} <span style="font-size:12px; color:var(--cyber-red-neon); float:right;">Ruts: ${State.plan.routinesAvailable.length}</span></h2>
                    ${routinesHtml}
                    <h2 style="font-size:18px; margin-bottom:10px; margin-top:20px;">Tu Red Neuronal</h2>
                    <div class="liquid-glass card" style="text-align:center; padding:15px;"><button class="cyber-button ai-button" id="btn-ia-setup" style="display:flex; justify-content:center; align-items:center; gap:10px;"><svg class="cyber-icon" style="width:24px; height:24px;" viewBox="0 0 24 24"><path d="M21 16.5c0 .38-.21.71-.53.88l-7.9 4.44c-.16.12-.36.18-.57.18s-.41-.06-.57-.18l-7.9-4.44A.991.991 0 013 16.5v-9c0-.38.21-.71.53-.88l7.9-4.44c.16-.12.36-.18.57-.18s.41.06.57.18l7.9 4.44c.32.17.53.5.53.88v9zM12 4.15L5.4 7.86l6.6 3.71 6.6-3.71L12 4.15zm0 14.7l6.6-3.71V7.86l-6.6 3.71v7.28z"/></svg> Generar Rutina Extra IA</button></div>
                `;
            },

            progreso: () => `
                <h2 style="margin-bottom: 15px;">Dashboard Evolutivo</h2>
                <div class="liquid-glass card" style="margin-bottom:20px;">
                    <div class="card-title">Peso y Composici√≥n</div>
                    <div class="chart-container"><canvas id="bioChart"></canvas></div>
                    <div style="display:flex; justify-content:space-around; margin-top:5px; font-size:11px; color:white;"><div><span style="color:#ff3333;">‚ñ†</span> Peso</div><div><span style="color:#ffaa00;">‚ñ†</span> Grasa</div><div><span style="color:#00ff88;">‚ñ†</span> M√∫sculo</div></div>
                </div>
                <div class="liquid-glass card" style="margin-bottom:20px;">
                    <div class="card-title">Per√≠metros y Pliegues</div>
                    <div class="chart-container"><canvas id="measureChart"></canvas></div>
                    <div style="display:flex; justify-content:center; flex-wrap:wrap; gap:10px; margin-top:10px; font-size:10px; color:white; padding:0 5px;">
                        <div><span style="color:#00d4ff;">‚ñ†</span> %Grasa</div><div><span style="color:#A133FF;">‚ñ†</span> Homb.</div><div><span style="color:#FF5733;">‚ñ†</span> Pecho</div>
                        <div><span style="color:#FF33A8;">‚ñ†</span> Brazo</div><div><span style="color:#00FF88;">‚ñ†</span> Cint.</div><div><span style="color:#2ECC71;">‚ñ†</span> Abd.</div>
                        <div><span style="color:#3357FF;">‚ñ†</span> Cad.</div><div><span style="color:#F3FF33;">‚ñ†</span> Muslo</div>
                    </div>
                </div>
                <div class="liquid-glass card" style="margin-bottom:20px;">
                    <div class="card-title" style="display:flex; justify-content:space-between; align-items:center;">Rendimiento <select id="prog-ex-select" style="background:rgba(10,10,10,0.8); color:var(--cyber-red-neon); border:1px solid var(--cyber-red-neon); border-radius:4px; font-size:11px; padding:2px;"><option value="Press Banca Barra">Press Banca</option></select></div>
                    <div class="chart-container"><canvas id="progressChart"></canvas></div>
                    <div style="display:flex; justify-content:space-around; margin-top:5px; font-size:11px; color:white;"><div><span style="color:#00ff88;">‚ñ†</span> Vol.</div><div><span style="color:#ffaa00;">‚ñ†</span> 1RM</div><div><span style="color:#ff3333;">‚ñ†</span> M√°x</div></div>
                </div>
                
                <div class="liquid-glass card" style="margin-bottom:20px;">
                    <div class="card-title">HUD Muscular Global (Telemetr√≠a)</div>
                    <div id="global-muscle-map"></div>
                </div>
            `,

            admin_dashboard: () => `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
                    <h2 style="display:flex; gap:10px; align-items:center; color:#ffcc00;">
                        <span class="view-trigger" data-target="perfil" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> 
                        Panel Coach
                    </h2>
                    <span style="font-size:11px; padding:4px 8px; background:rgba(255,204,0,0.1); color:#ffcc00; border:1px solid #ffcc00; border-radius:4px;">ADMIN</span>
                </div>
                
                <div class="menu-grid">
                    <div class="liquid-glass menu-item view-trigger" data-target="admin_atletas"><div class="menu-icon"><svg class="cyber-icon" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></div><span>Clientes</span></div>
                    <div class="liquid-glass menu-item view-trigger" data-target="admin_rutinas"><div class="menu-icon"><svg class="cyber-icon" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg></div><span>Rutinas</span></div>
                    <div class="liquid-glass menu-item view-trigger" data-target="admin_planes"><div class="menu-icon"><svg class="cyber-icon" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm4.24 16L12 15.45 7.77 18l1.12-4.81-3.73-3.23 4.92-.42L12 5l1.92 4.53 4.92.42-3.73 3.23L16.23 18z"/></svg></div><span>Planes</span></div>
                    <div class="liquid-glass menu-item view-trigger" data-target="admin_chat"><div class="menu-icon"><svg class="cyber-icon" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg></div><span>Inbox</span></div>
                    <div class="liquid-glass menu-item view-trigger" data-target="admin_agenda"><div class="menu-icon"><svg class="cyber-icon" viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 002 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2zm-7 5h5v5h-5z"/></svg></div><span>Agenda</span></div>
                </div>
            `,

            admin_atletas: () => {
                setTimeout(() => loadAdminContent('atletas'), 50);
                return `<h2 style="display:flex; gap:10px; align-items:center; margin-bottom:15px; color:#ffcc00;"><span class="view-trigger" data-target="admin_dashboard" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> Directorio Clientes</h2><div id="admin-subcontent"><div class="ai-loader" style="margin-top:40px;">Conectando...</div></div>`;
            },
            admin_rutinas: () => {
                setTimeout(() => loadAdminContent('rutinas'), 50);
                return `<h2 style="display:flex; gap:10px; align-items:center; margin-bottom:15px; color:#ffcc00;"><span class="view-trigger" data-target="admin_dashboard" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> Creador de Rutinas</h2><div id="admin-subcontent"><div class="ai-loader" style="margin-top:40px;">Iniciando sistema...</div></div>`;
            },
            admin_planes: () => {
                setTimeout(() => loadAdminContent('planes'), 50);
                return `<h2 style="display:flex; gap:10px; align-items:center; margin-bottom:15px; color:#ffcc00;"><span class="view-trigger" data-target="admin_dashboard" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> Gestor de Planes</h2><div id="admin-subcontent"><div class="ai-loader" style="margin-top:40px;">Sincronizando...</div></div>`;
            },
            admin_chat: () => {
                setTimeout(() => loadAdminContent('chat'), 50);
                return `<h2 style="display:flex; gap:10px; align-items:center; margin-bottom:15px; color:#ffcc00;"><span class="view-trigger" data-target="admin_dashboard" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> Inbox Coach</h2><div id="admin-subcontent"><div class="ai-loader" style="margin-top:40px;">Cargando...</div></div>`;
            },
            admin_agenda: () => {
                setTimeout(() => loadAdminContent('agenda'), 50);
                return `<h2 style="display:flex; gap:10px; align-items:center; margin-bottom:15px; color:#ffcc00;"><span class="view-trigger" data-target="admin_dashboard" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> Agenda de Citas</h2><div id="admin-subcontent"><div class="ai-loader" style="margin-top:40px;">Cargando calendario...</div></div>`;
            },

            mensajes: () => {
                setTimeout(async () => {
                    const box = document.getElementById('chat-box');
                    if (!box) return;

                    box.innerHTML = `<p style="color:var(--cyber-text-gray); font-size:12px; text-align:center; margin-top:40px;">Conectando al servidor...</p>`;

                    try {
                        if (window.activeClientChatUnsubscribe) window.activeClientChatUnsubscribe();

                        const { db, doc, onSnapshot, auth } = await import('./js/firebase.js');
                        const uid = auth.currentUser ? auth.currentUser.uid : State.profile.id;

                        if (!uid) {
                            box.innerHTML = `<p style="color:red; font-size:12px; text-align:center;">Error: Usuario no autenticado.</p>`;
                            return;
                        }

                        const docRef = doc(db, "users", uid);

                        window.activeClientChatUnsubscribe = onSnapshot(docRef, (docSnap) => {
                            const currentBox = document.getElementById('chat-box');
                            if (!currentBox) {
                                window.activeClientChatUnsubscribe();
                                return;
                            }

                            if (docSnap.exists()) {
                                const userData = docSnap.data();
                                const msgs = userData?.messages || [];

                                // Notificaci√≥n de nuevo mensaje entrante del coach
                                if (window.lastMsgCount !== undefined && msgs.length > window.lastMsgCount) {
                                    const lastMsg = msgs[msgs.length - 1];
                                    if (lastMsg.sender === 'coach' && Notification.permission === 'granted') {
                                        new Notification('Nuevo mensaje de tu Coach', {
                                            body: lastMsg.text,
                                            icon: 'img/logo.png'
                                        });
                                    }
                                }
                                window.lastMsgCount = msgs.length;

                                let msgsHtml = msgs.length === 0 ? `<p style="color:#aaa; font-size:12px; text-align:center; font-style:italic; margin-top:20px;">Env√≠a un mensaje a tu coach para empezar.</p>` : '';

                                msgs.forEach(m => {
                                    msgsHtml += `<div class="msg ${m.sender}">${m.text}<span class="msg-time">${m.time}</span></div>`;
                                });

                                const isAtBottom = currentBox.scrollHeight - currentBox.scrollTop <= currentBox.clientHeight + 50;
                                currentBox.innerHTML = msgsHtml;
                                if (isAtBottom) setTimeout(() => currentBox.scrollTop = currentBox.scrollHeight, 50);
                            }
                        });
                    } catch (e) {
                        console.error("Chat setup error", e);
                        box.innerHTML = `<p style="color:red; font-size:12px; text-align:center;">Fallo de conexi√≥n cifrada.</p>`;
                    }
                }, 100);

                return `<h2 style="margin-bottom: 15px;">Transmisi√≥n con Coach</h2>
                <div class="liquid-glass card chat-container" style="padding:15px;">
                    <div class="chat-messages" id="chat-box" style="min-height:300px; max-height:400px; overflow-y:auto; display:flex; flex-direction:column;"></div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chat-input-text" placeholder="Escribe a tu coach..." onkeydown="if(event.key === 'Enter') document.getElementById('btn-chat-send').click()">
                        <button class="chat-send" id="btn-chat-send">
                            <svg style="width:20px;height:20px;fill:white;" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                        </button>
                    </div>
                </div>`;
            },

            // --- IA Y WORKOUT PLAYER AVANZADO (AUTOFILL + MARCAR TODO + DROPSET EXACTO) ---
            ia_setup: () => `<h2 style="margin-bottom: 15px; display:flex; gap:10px; align-items:center;"><span class="view-trigger" data-target="plan" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> Par√°metros IA</h2><div class="liquid-glass card auth-form"><label style="font-size:12px; color:var(--cyber-red-neon);">Objetivo / M√∫sculo</label><div class="select-wrapper"><select id="ai-target"><option value="pecho">Pecho</option><option value="espalda">Espalda</option><option value="piernas">Piernas</option><option value="brazos">Brazos</option></select></div><label style="font-size:12px; color:var(--cyber-red-neon);">Nivel</label><div class="select-wrapper"><select id="ai-level"><option value="principiante">Principiante</option><option value="avanzado">Avanzado</option></select></div><label style="font-size:12px; color:var(--cyber-red-neon);">Tiempo</label><div class="select-wrapper"><select id="ai-time"><option value="30">30 min</option><option value="45" selected>45 min</option></select></div><button class="cyber-button ai-button" id="btn-generate-ai" style="margin-top:20px;">Iniciar C√°lculo</button></div>`,
            ia_loading: () => `<div class="liquid-glass card" style="margin-top:50px; text-align:center;"><div class="ai-loader">Analizando biometr√≠a y cruzando base de datos</div><p style="font-size:11px; color:var(--cyber-text-gray); margin-top:10px;">Aplicando variables de peso (${State.profile.weight}kg) y grasa (${State.profile.fat}%)...</p></div>`,
            ia_result: () => `<h2 style="margin-bottom: 15px; color:var(--cyber-white);">Rutina Optimizada</h2><div class="liquid-glass card" style="padding:15px;"><ul style="list-style:none; padding:0; color:var(--cyber-text-gray); font-size:14px;">${State.routine.map((ex, i) => `<li style="padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.05);"><strong>${i + 1}.</strong> ${ex.n}</li>`).join('')}</ul><button class="cyber-button ai-button" id="btn-start-ai-workout" style="margin-top:20px;">Iniciar Entreno Ahora</button><button class="cyber-button secondary view-trigger" data-target="ia_setup" style="margin-top:10px;">Descartar</button></div>`,

            workout_player: () => {
                if (!State.activeWorkout || State.activeWorkout.length === 0) {
                    return `<h2 style="margin-bottom: 15px; display:flex; gap:10px; align-items:center;"><span class="view-trigger" data-target="plan" style="cursor:pointer; color:var(--cyber-red-neon); font-size:24px;">‚Üê</span> Entreno R√°pido</h2><div class="liquid-glass card" style="text-align:center; padding:30px;"><p style="color:red; font-size:14px; margin-bottom:15px;">No hay rutina activa iniciada.</p><button class="cyber-button view-trigger" data-target="plan">Volver al Plan</button></div>`;
                }
                const currentEx = State.activeWorkout[State.currentExerciseIndex];
                const isLast = State.currentExerciseIndex === State.activeWorkout.length - 1;

                let setsHtml = '';
                currentEx.sets.forEach((set, idx) => {
                    const checkClass = `set-checkbox ${set.done ? 'checked' : ''}`;
                    const disabled = set.done ? 'disabled' : '';

                    const nextSet = currentEx.sets[idx + 1];
                    const hasDropActive = (nextSet && nextSet.isDrop && nextSet.parentId === set.id);
                    const dropBtnClass = `btn-drop ${hasDropActive ? 'active' : ''}`;

                    // AUTOFILL logic
                    const displayR = set.r || set.prevR || set.targetR || '';
                    const displayW = set.w || set.prevW || '';

                    // Leer PR espec√≠fico de la serie
                    const exMaxes = State.profile.maxWeights[currentEx.name] || {};
                    const setPR = exMaxes[idx] || 0;

                    const historyHtml = !set.isDrop
                        ? `<div class="set-history-sub"><span>Ant: ${set.prevR || 0}x${set.prevW || 0}kg</span><span><span style="color:gold;">üèÖ</span> M√°x: ${setPR}kg</span></div>`
                        : `<div class="set-history-sub" style="color:#ffaa00;">Dropset Telemetr√≠a (-32% Carga)</div>`;

                    setsHtml += `
                    <div class="set-wrapper ${set.isDrop ? 'is-drop' : ''}">
                        <div class="set-row ${set.done ? 'done' : ''}">
                            <div style="font-weight:bold; font-size:13px; text-align:center; color:var(--cyber-text-gray);">${set.id}</div>
                            <input type="number" class="set-input set-r" placeholder="Reps" value="${displayR}" ${disabled}>
                            <input type="number" class="set-input set-w" placeholder="Kg" value="${displayW}" ${disabled}>
                            <div class="${checkClass}" data-ex="${State.currentExerciseIndex}" data-set="${idx}"></div>
                            ${!set.isDrop ? `<div class="${dropBtnClass}" data-ex="${State.currentExerciseIndex}" data-set="${idx}"><svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M12 2L1 21h22M12 6l7.5 13h-15M11 10h2v4h-2M11 16h2v2h-2"/></svg></div>` : '<div></div>'}
                        </div>
                        ${historyHtml}
                    </div>`;
                });

                return `
                <p style="color:var(--cyber-text-gray); font-size:12px; margin-bottom:5px;">Ejercicio ${State.currentExerciseIndex + 1} de ${State.activeWorkout.length}</p>
                <div class="workout-header">
                    <h2 style="font-size:20px; color:var(--cyber-red-neon); margin-bottom:5px;">${currentEx.name}</h2>
                </div>
                
                <div class="liquid-glass card auth-form" style="padding: 10px; margin-bottom:20px;">
                    <textarea class="ex-notes" placeholder="Ajustes de m√°quina (Ej: Asiento al 3) - Se guarda para siempre" style="min-height:40px; font-size:12px;">${State.profile.machineNotes[currentEx.name] || ''}</textarea>
                    
                    <div style="display:grid; grid-template-columns: 25px 1fr 1fr 35px 35px; gap:6px; color:var(--cyber-text-gray); font-size:11px; font-weight:bold; border-bottom:1px solid #333; padding-bottom:5px; margin-top:10px; text-align:center;">
                        <div>#</div><div>Reps</div><div>Kg</div><div>‚úì</div><div><svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><path d="M12 2L1 21h22M12 6l7.5 13h-15M11 10h2v4h-2M11 16h2v2h-2"/></svg></div>
                    </div>
                    
                    <div style="margin-top:10px;">${setsHtml}</div>
                    
                    <textarea class="ex-obs" placeholder="Observaciones de hoy (Ej: Molestia hombro)" style="min-height:40px; font-size:12px; margin-top:10px;">${currentEx.obs || ''}</textarea>

                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button class="cyber-button secondary" id="btn-swap-ex" style="flex:1; font-size:11px; padding:0;">üîÅ Cambio</button>
                        <button class="cyber-button secondary" id="btn-add-set" style="flex:1; font-size:11px; padding:0;">+ Serie</button>
                        <button class="cyber-button" id="btn-mark-all" style="flex:1; font-size:11px; padding:0; background:#00ff88; color:black; border:none;">‚úî Todo</button>
                    </div>
                </div>

                <div style="display:flex; gap:10px; margin-top:20px;">
                    <button class="cyber-button secondary" id="btn-abort-workout" style="flex:1;">Abortar</button>
                    <button class="cyber-button" id="btn-next-exercise" style="flex:1;">${isLast ? 'FINALIZAR' : 'Siguiente'}</button>
                </div>`;
            }
        };

        // ==========================================
        // RENDER DE CHART.JS
        // ==========================================
        function drawProgressChart() {
            if (typeof Chart === 'undefined') { setTimeout(drawProgressChart, 500); return; }

            if (document.getElementById('bioChart') && State.charts.bio) State.charts.bio.destroy();
            if (document.getElementById('bioChart')) {
                const hasRealData = State.profile.weight || State.profile.fat || State.profile.muscle;
                State.charts.bio = new Chart(document.getElementById('bioChart'), {
                    type: 'line', data: {
                        labels: hasRealData ? ['Reciente'] : [], datasets: [
                            { label: 'Peso', data: hasRealData ? [State.profile.weight || 0] : [], borderColor: '#ff3333', tension: 0.3 },
                            { label: 'Grasa', data: hasRealData ? [State.profile.fat || 0] : [], borderColor: '#ffaa00', tension: 0.3 },
                            { label: 'M√∫sculo', data: hasRealData ? [State.profile.muscle || 0] : [], borderColor: '#00ff88', tension: 0.3 }
                        ]
                    }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false } } }
                });
            }

            if (document.getElementById('measureChart') && State.charts.measure) State.charts.measure.destroy();
            if (document.getElementById('measureChart')) {
                // If there is no real data, pass an empty dataset so it doesn't show ghost data
                const hasRealData = State.profile.weight || State.profile.fat;

                State.charts.measure = new Chart(document.getElementById('measureChart'), {
                    type: 'line', data: {
                        labels: hasRealData ? ['Reciente'] : [], datasets: [
                            { label: '% Grasa (JP7)', data: hasRealData ? [State.profile.fat || 0] : [], borderColor: '#00d4ff', backgroundColor: 'rgba(0,212,255,0.1)', fill: true, tension: 0.4 },
                            { label: 'Peso', data: hasRealData ? [State.profile.weight || 0] : [], borderColor: '#A133FF', borderDash: [3, 3], tension: 0.3, pointRadius: 1 }
                        ]
                    }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false } } }
                });
            }

            if (document.getElementById('progressChart') && State.charts.progress) State.charts.progress.destroy();
            if (document.getElementById('progressChart')) {
                const hasHistory = State.history && State.history.length > 0;

                State.charts.progress = new Chart(document.getElementById('progressChart'), {
                    type: 'line', data: {
                        labels: hasHistory ? State.history.map(h => formatYMD(new Date(h.timestamp))) : [],
                        datasets: [
                            { label: 'RPE Global', data: hasHistory ? State.history.map(h => h.rpe || 0) : [], borderColor: '#00ff88', backgroundColor: 'rgba(0,255,136,0.1)', fill: true, tension: 0.4 },
                        ]
                    }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false } } }
                });
            }

            // Render Global HUD in Progress
            if (State.currentView === 'progreso') {
                const recentMuscles = {};
                if (State.history && State.history.length > 0) {
                    const oneWeekAgo = new Date();
                    oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

                    State.history.forEach(workout => {
                        const wDate = new Date(workout.timestamp);
                        if (wDate >= oneWeekAgo && workout.muscles) {
                            for (let m in workout.muscles) {
                                if (!recentMuscles[m]) recentMuscles[m] = 0;
                                recentMuscles[m] += workout.muscles[m];
                            }
                        }
                    });
                }
                renderHUDMap('global-muscle-map', recentMuscles);
            }
        }

        function navigateTo(viewName) {
            if (Views[viewName]) {
                DOM.view.innerHTML = Views[viewName]();
                State.currentView = viewName;
                window.scrollTo(0, 0);
                if (viewName === 'progreso') drawProgressChart();
                if (viewName === 'mensajes') { const box = document.getElementById('chat-box'); if (box) box.scrollTop = box.scrollHeight; }

                // Banner Flotante Entreno Activo
                const banner = document.getElementById('active-workout-banner');
                if (banner) {
                    if (State.activeWorkout && viewName !== 'workout_player') banner.classList.remove('hidden');
                    else banner.classList.add('hidden');
                }
            }
            DOM.navItems.forEach(item => item.classList.toggle('active', item.dataset.view === viewName));
        }

        // ==========================================
        // GESTOR DE EVENTOS GLOBAL (Delegaci√≥n Definitiva)
        // ==========================================
        document.body.addEventListener('input', (e) => {
            if (e.target.id === 'prof-dob') {
                const newAge = calculateAge(e.target.value);
                const display = document.getElementById('age-display');
                if (display) display.textContent = newAge ? `(${newAge} a√±os)` : '';
                State.profile.dob = e.target.value;
            }

            if (e.target.classList.contains('jp7-input')) {
                const inputs = document.querySelectorAll('.jp7-input');
                let sum = 0; let allFilled = true;
                inputs.forEach(inp => { if (!inp.value) allFilled = false; sum += parseFloat(inp.value) || 0; });
                if (allFilled) {
                    const bf = calculateJP7(sum, calculateAge(State.profile.dob), State.profile.gender);
                    if (bf) document.getElementById('bio-fat').value = bf;
                }
            }

            // GESTI√ìN SUBIDA IM√ÅGENES COMPARATIVA
            if (e.target.id === 'upload-inicio' || e.target.id === 'upload-actual') {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        const base64Img = ev.target.result;
                        const type = e.target.id === 'upload-inicio' ? 'inicio' : 'actual';
                        const angle = State.comparativaAngle || 'frontal';
                        const compositeKey = `${type}_${angle}`;

                        // 1. Mostrar Preview Local instant√°neo
                        State.comparativaImages = State.comparativaImages || {};
                        State.comparativaImages[compositeKey] = base64Img;

                        if (type === 'inicio') {
                            const img = document.getElementById('img-before');
                            if (img) img.src = base64Img;
                        } else {
                            const img = document.querySelector('.slider-img.after');
                            if (img) img.src = base64Img;
                        }

                        // 2. Subir a Firebase Storage y Database
                        const lbl = e.target.closest('label');
                        const originalText = lbl ? lbl.innerHTML.trim() : "";
                        if (lbl) lbl.innerHTML = `<span style="color:#fff;">Subiendo...</span>`;

                        const downloadUrl = await uploadComparativaImage(State.profile.uid, compositeKey, base64Img);
                        if (downloadUrl) {
                            State.comparativaImages[compositeKey] = downloadUrl;
                            await updateProfile(State.profile.uid, { comparativaImages: State.comparativaImages });
                            if (lbl) lbl.innerHTML = `<span style="color:var(--cyber-green);">¬°Guardada!</span>`;
                            setTimeout(() => { if (lbl) lbl.innerHTML = originalText; }, 2000);
                        } else {
                            alert("Hubo un error al subir la imagen en la nube.");
                            if (lbl) lbl.innerHTML = originalText;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }

            if (e.target.classList.contains('ex-notes')) { const currentExName = State.activeWorkout[State.currentExerciseIndex].name; State.profile.machineNotes[currentExName] = e.target.value; }
            if (e.target.classList.contains('ex-obs')) { State.activeWorkout[State.currentExerciseIndex].obs = e.target.value; }

            // Slider Fotogr√°fico
            if (e.target.id === 'photo-slider') {
                const val = e.target.value;
                document.getElementById('img-before').style.clipPath = `polygon(0 0, ${val}% 0, ${val}% 100%, 0 100%)`;
                document.getElementById('slider-line').style.left = `${val}%`;
            }
            if (e.target.id === 'comp-date-1') { const l1 = document.getElementById('label-img-1'); if (l1) l1.textContent = e.target.options[e.target.selectedIndex].text.toUpperCase(); }
            if (e.target.id === 'comp-date-2') { const l2 = document.getElementById('label-img-2'); if (l2) l2.textContent = e.target.options[e.target.selectedIndex].text.toUpperCase(); }
            if (e.target.id === 'prog-ex-select') drawProgressChart();
        });

        document.body.addEventListener('pointerup', async (e) => {
            const navItem = e.target.closest('.nav-item');
            if (navItem && navItem.dataset.view !== State.currentView) navigateTo(navItem.dataset.view);
            const trigger = e.target.closest('.view-trigger');
            if (trigger) {
                document.getElementById('fab-modal').classList.remove('active');
                document.getElementById('modal-rpe').classList.remove('active');
                navigateTo(trigger.dataset.target);
            }
            if (e.target.closest('#btn-logout')) {
                await signOut(auth);
                window.location.reload(); // Hard reset para evitar data leak al cambiar de usuario
            }

            // Banner Flotante Clic (Volver a entreno activo)
            if (e.target.closest('#active-workout-banner')) navigateTo('workout_player');
            if (e.target.closest('#btn-back-workout')) document.getElementById('modal-rpe').classList.remove('active');

            // CALENDARIO CLICKS
            const calDay = e.target.closest('.cal-day');
            if (calDay) { State.plan.activeDate = calDay.dataset.date; navigateTo('plan'); }

            // MODAL INSTALACI√ìN PWA
            if (e.target.closest('#btn-show-install')) { e.preventDefault(); document.getElementById('modal-install').classList.add('active'); }
            if (e.target.closest('#close-install-modal')) document.getElementById('modal-install').classList.remove('active');

            // CHAT ENVIAR MENSAJE
            if (e.target.closest('#btn-chat-send')) {
                const inp = document.getElementById('chat-input-text');
                if (inp && inp.value.trim() !== '') {
                    const btn = e.target.closest('#btn-chat-send');
                    btn.style.opacity = '0.5';
                    AdminController.sendClientMessage(inp.value.trim()).then((msgs) => {
                        btn.style.opacity = '1';
                        if (msgs) {
                            inp.value = '';
                            navigateTo('mensajes');
                        } else {
                            alert("Fallo estableciendo la transmisi√≥n.");
                        }
                    });
                }
            }

            // MODALES FAB
            if (e.target.closest('#fab-trigger')) document.getElementById('fab-modal').classList.add('active');
            if (e.target.closest('#close-modal')) document.getElementById('fab-modal').classList.remove('active');

            const modalAction = e.target.closest('.modal-action');
            if (modalAction && modalAction.id !== 'close-modal' && modalAction.id !== 'btn-ia-setup-fab') {
                const action = modalAction.dataset.action;
                document.getElementById('fab-modal').classList.remove('active');
                if (action === 'weight' || action === 'fat' || action === 'measures') {
                    navigateTo('estado_fisico');
                    if (action === 'measures') {
                        setTimeout(() => {
                            const jp7 = document.getElementById('jp7-content');
                            if (jp7) { jp7.classList.remove('hidden'); document.getElementById('jp7-arrow').textContent = '‚ñ≤'; }
                        }, 50);
                    }
                } else if (action === 'meal') navigateTo('log_comida');
            }

            // ACORDEONES
            if (e.target.closest('#btn-toggle-jp7')) {
                const content = document.getElementById('jp7-content');
                content.classList.toggle('hidden');
                document.getElementById('jp7-arrow').textContent = content.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
            }
            if (e.target.closest('#btn-toggle-perimeters')) {
                const content = document.getElementById('perim-content');
                content.classList.toggle('hidden');
                document.getElementById('perim-arrow').textContent = content.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
            }

            // L√ìGICA DE PAGOS
            if (e.target.closest('#btn-pay-plan')) {
                const selected = document.querySelector('.plan-card-input:checked');
                if (!selected) return alert("Selecciona un plan.");
                document.getElementById('modal-payment').classList.add('active');
            }
            if (e.target.closest('#close-payment-modal')) document.getElementById('modal-payment').classList.remove('active');
            if (e.target.closest('#btn-pay-bizum')) {
                const planName = document.querySelector('.plan-card-input:checked').value;
                alert(`üì± BIZUM (0% Comisiones)\n\n1. Env√≠a el importe al: 614 056 363\n2. Concepto: "${State.profile.name} - #${State.profile.id}"\n\nCoach validar√° tu ${planName}.`);
                document.getElementById('modal-payment').classList.remove('active');
            }
            if (e.target.closest('#btn-pay-sumup')) {
                const planValue = document.querySelector('.plan-card-input:checked').value;
                let link = 'https://pay.sumup.com/b2c/DEFAULT';
                if (planValue.includes('APP')) link = 'https://pay.sumup.com/b2c/PLAN_APP';
                if (planValue.includes('Preparaci√≥n')) link = 'https://pay.sumup.com/b2c/PLAN_PREP';
                if (planValue.includes('4 Sesiones')) link = 'https://pay.sumup.com/b2c/PLAN_4SES';
                if (planValue.includes('8 Sesiones')) link = 'https://pay.sumup.com/b2c/PLAN_8SES';
                if (planValue.includes('Suelta')) link = 'https://pay.sumup.com/b2c/PLAN_SUELTA';
                window.open(link, '_blank');
                document.getElementById('modal-payment').classList.remove('active');
            }

            // COMPARATIVA FOTOS
            const angleBtn = e.target.closest('.angle-btn');
            if (angleBtn) { State.comparativaAngle = angleBtn.dataset.angle; navigateTo('comparativa'); }
            if (e.target.closest('#btn-upload-inicio') || e.target.closest('#btn-upload-actual')) { alert("Abriendo galer√≠a segura de dispositivo..."); }

            // GUARDADO DE DATOS BASE
            if (e.target.closest('#btn-save-profile')) alert("Datos personales actualizados.");
            if (e.target.closest('#btn-save-bio')) {
                State.profile.weight = document.getElementById('bio-weight').value;
                State.profile.height = document.getElementById('bio-height').value;
                State.profile.fat = document.getElementById('bio-fat').value;
                State.profile.muscle = document.getElementById('bio-muscle').value;
                State.profile.objective = document.getElementById('bio-obj').value;
                State.profile.restTimerDefault = parseInt(document.getElementById('bio-rest').value) || 60;
                alert("Biometr√≠a sincronizada. La IA y el Timer est√°n calibrados.");
            }
            if (e.target.closest('#btn-save-meal')) { alert("Registro nutricional enviado a tu historial."); navigateTo('historial'); }

            // IA Y WORKOUT INIT
            if (e.target.closest('#btn-ia-setup') || e.target.closest('#btn-ia-setup-fab')) {
                document.getElementById('fab-modal').classList.remove('active');
                if (!State.profile.weight) { alert("‚ö†Ô∏è Faltan datos biom√©tricos. Ve a 'Estado F√≠sico'."); navigateTo('estado_fisico'); return; }
                navigateTo('ia_setup');
            }
            if (e.target.closest('#btn-generate-ai')) {
                const target = document.getElementById('ai-target').value; const level = document.getElementById('ai-level').value; const time = document.getElementById('ai-time').value;
                navigateTo('ia_loading');
                setTimeout(() => { State.routine = generateAIRoutine(target, level, time); navigateTo('ia_result'); }, 3000);
            }
            if (e.target.closest('#btn-start-ai-workout')) {
                State.activeWorkout = State.routine.map(ex => ({
                    name: ex.n, notes: '', obs: '',
                    sets: [
                        { id: 1, targetR: 20, r: '', w: '', done: false, prevW: 0, prevR: 0, isDrop: false },
                        { id: 2, targetR: 16, r: '', w: '', done: false, prevW: 0, prevR: 0, isDrop: false },
                        { id: 3, targetR: 16, r: '', w: '', done: false, prevW: 0, prevR: 0, isDrop: false },
                        { id: 4, targetR: 16, r: '', w: '', done: false, prevW: 0, prevR: 0, isDrop: false },
                        { id: 5, targetR: 16, r: '', w: '', done: false, prevW: 0, prevR: 0, isDrop: false }
                    ]
                }));
                State.currentExerciseIndex = 0;
                navigateTo('workout_player');
            }

            // --- L√ìGICA WORKOUT (SWAP MODAL) ---
            if (e.target.closest('#btn-swap-ex')) {
                const currentName = State.activeWorkout[State.currentExerciseIndex].name;
                const currentData = EXERCISES.find(ex => ex.n === currentName);
                if (currentData) {
                    const alternatives = EXERCISES.filter(ex => ex.m === currentData.m && ex.n !== currentName);
                    if (alternatives.length > 0) {
                        const listContainer = document.getElementById('swap-list-container');
                        listContainer.innerHTML = '';
                        alternatives.forEach(alt => {
                            const div = document.createElement('div');
                            div.className = 'swap-item'; div.innerHTML = `<b>${alt.n}</b>`; div.dataset.name = alt.n;
                            listContainer.appendChild(div);
                        });
                        document.getElementById('modal-swap').classList.add('active');
                    } else { alert("No hay alternativas de ese grupo muscular."); }
                }
            }
            if (e.target.closest('#close-swap-modal')) document.getElementById('modal-swap').classList.remove('active');

            if (e.target.closest('.swap-item')) {
                const newExName = e.target.closest('.swap-item').dataset.name;
                State.activeWorkout[State.currentExerciseIndex].name = newExName;
                document.getElementById('modal-swap').classList.remove('active');
                showToast(`üîÅ Cambiado a: ${newExName}`);
                navigateTo('workout_player');
            }

            if (e.target.closest('#btn-add-set')) {
                const ex = State.activeWorkout[State.currentExerciseIndex];
                ex.sets.push({ id: ex.sets.length + 1, targetR: 16, r: '', w: '', done: false, prevW: 0, prevR: 0, isDrop: false });
                navigateTo('workout_player');
            }

            // MARCAR TODO (AUTOFILL)
            if (e.target.closest('#btn-mark-all')) {
                const currentEx = State.activeWorkout[State.currentExerciseIndex];
                const rows = document.querySelectorAll('.set-row');
                currentEx.sets.forEach((set, idx) => {
                    if (!set.done) {
                        const row = rows[idx];
                        if (row) {
                            const rInp = row.querySelector('.set-r'); const wInp = row.querySelector('.set-w');
                            const rVal = rInp.value || set.prevR || set.targetR || 0;
                            const wVal = wInp.value || set.prevW || 0;
                            set.r = parseInt(rVal); set.w = parseFloat(wVal); set.done = true;

                            if (!State.profile.maxWeights[currentEx.name]) State.profile.maxWeights[currentEx.name] = {};
                            const currentMax = State.profile.maxWeights[currentEx.name][idx] || 0;
                            if (set.w > currentMax) { State.profile.maxWeights[currentEx.name][idx] = set.w; }

                            if (set.w > 0 && set.r > 0) {
                                const est1RM = Math.round(set.w / (1.0278 - (0.0278 * set.r)));
                                const currentRecord = State.profile.rmRecords[currentEx.name] || 0;
                                if (est1RM > currentRecord) { State.profile.rmRecords[currentEx.name] = est1RM; showToast(`üî• ¬°NUEVO NIVEL! 1RM Est: <b>${est1RM}kg</b>`); }
                            }
                        }
                    }
                });
                if (navigator.vibrate) navigator.vibrate(20);
                navigateTo('workout_player');
            }

            // GESTI√ìN DE DROPSET (LECTURA EXACTA Y MATEM√ÅTICA)
            if (e.target.closest('.btn-drop')) {
                const btn = e.target.closest('.btn-drop');
                const exIdx = parseInt(btn.dataset.ex); const setIdx = parseInt(btn.dataset.set);
                const workout = State.activeWorkout[exIdx];
                const currentSet = workout.sets[setIdx];

                // 1. Forzar lectura del input DOM ANTES de procesar
                const row = btn.closest('.set-row');
                if (row) {
                    const rInp = row.querySelector('.set-r'); const wInp = row.querySelector('.set-w');
                    currentSet.r = parseInt(rInp.value || currentSet.prevR || currentSet.targetR || 0);
                    currentSet.w = parseFloat(wInp.value || currentSet.prevW || 0);
                }

                const nextSet = workout.sets[setIdx + 1];

                // 2. Toggle: Si ya existe el dropset hijo, se borra y reabre la actual
                if (nextSet && nextSet.isDrop && nextSet.parentId === currentSet.id) {
                    workout.sets.splice(setIdx + 1, 1);
                    currentSet.done = false;
                } else {
                    // 3. Crear Dropset
                    const targetR = parseInt(currentSet.targetR || 16);
                    const actualR = parseInt(currentSet.r || 0);
                    const actualW = parseFloat(currentSet.w || 0);

                    const remainingReps = Math.max(0, targetR - actualR);
                    const dropTargetReps = remainingReps + 4; // Faltantes + 4 extra
                    const dropW = actualW > 0 ? Math.round(actualW * 0.68) : 0; // -32%

                    currentSet.done = true; // Cerrar la original

                    if (!State.profile.maxWeights[workout.name]) State.profile.maxWeights[workout.name] = {};
                    if (actualW > (State.profile.maxWeights[workout.name][setIdx] || 0)) {
                        State.profile.maxWeights[workout.name][setIdx] = actualW;
                    }
                    if (actualW > 0 && actualR > 0) {
                        const est1RM = Math.round(actualW / (1.0278 - (0.0278 * actualR)));
                        if (est1RM > (State.profile.rmRecords[workout.name] || 0)) { State.profile.rmRecords[workout.name] = est1RM; showToast(`üî• ¬°NUEVO NIVEL! 1RM Est: <b>${est1RM}kg</b>`); }
                    }

                    workout.sets.splice(setIdx + 1, 0, {
                        id: currentSet.id + 0.5, isDrop: true, parentId: currentSet.id,
                        targetR: dropTargetReps, r: '', w: dropW, done: false, prevW: 0, prevR: 0
                    });
                }
                navigateTo('workout_player');
            }

            // GESTI√ìN CHECKBOX MANUAL (SERIE √öNICA)
            if (e.target.closest('.set-checkbox')) {
                initAudioEngine();
                const checkbox = e.target.closest('.set-checkbox'); const exIdx = checkbox.dataset.ex; const setIdx = checkbox.dataset.set; const setObj = State.activeWorkout[exIdx].sets[setIdx]; const row = checkbox.closest('.set-row');

                if (!setObj.done) {
                    const rInp = row.querySelector('.set-r'); const wInp = row.querySelector('.set-w');
                    const r = parseInt(rInp.value || setObj.prevR || setObj.targetR || 0);
                    const w = parseFloat(wInp.value || setObj.prevW || 0);
                    setObj.w = w; setObj.r = r;

                    if (!State.profile.maxWeights[State.activeWorkout[exIdx].name]) State.profile.maxWeights[State.activeWorkout[exIdx].name] = {};
                    if (w > (State.profile.maxWeights[State.activeWorkout[exIdx].name][setIdx] || 0)) { State.profile.maxWeights[State.activeWorkout[exIdx].name][setIdx] = w; }

                    if (w > 0 && r > 0) {
                        const est1RM = Math.round(w / (1.0278 - (0.0278 * r)));
                        if (est1RM > (State.profile.rmRecords[State.activeWorkout[exIdx].name] || 0)) { State.profile.rmRecords[State.activeWorkout[exIdx].name] = est1RM; showToast(`üî• ¬°NUEVO NIVEL! 1RM Est: <b>${est1RM}kg</b>`); }
                    }
                    setObj.done = true; if (navigator.vibrate) navigator.vibrate(10);
                    navigateTo('workout_player');

                    if (!setObj.isDrop) {
                        document.getElementById('modal-timer').classList.add('active');
                        State.restTimeLeft = State.profile.restTimerDefault; State.lastBeepSecond = -1;
                        if (State.timerInt) clearInterval(State.timerInt);
                        State.timerInt = setInterval(() => {
                            State.restTimeLeft--;
                            const d = document.getElementById('timer-display-main');
                            if (d) { const m = Math.floor(State.restTimeLeft / 60); const s = State.restTimeLeft % 60; d.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; d.style.color = State.restTimeLeft <= 5 ? "#fff" : "var(--cyber-red-neon)"; }
                            if (State.restTimeLeft <= 5 && State.restTimeLeft > 0) { if (State.restTimeLeft !== State.lastBeepSecond) { playTickSound(false); State.lastBeepSecond = State.restTimeLeft; } }
                            if (State.restTimeLeft <= 0) {
                                clearInterval(State.timerInt);
                                document.getElementById('modal-timer').classList.remove('active');
                                playTickSound(true);

                                // Push Notification (Compatible con Smartwatch)
                                if (Notification.permission === 'granted') {
                                    navigator.serviceWorker.ready.then(registration => {
                                        registration.showNotification('¬°Descanso Terminado!', {
                                            body: 'Prep√°rate para la siguiente serie.',
                                            icon: 'img/logo.png',
                                            vibrate: [200, 100, 200, 100, 200, 100, 200]
                                        });
                                    }).catch(fallback => {
                                        new Notification('¬°Descanso Terminado!', { body: 'A por la siguiente serie.', icon: 'img/logo.png' });
                                    });
                                }
                            }
                        }, 1000);
                    }
                } else { setObj.done = false; navigateTo('workout_player'); }
            }

            if (e.target.closest('#btn-timer-skip')) { clearInterval(State.timerInt); document.getElementById('modal-timer').classList.remove('active'); }
            if (e.target.closest('#btn-timer-plus')) { State.restTimeLeft += 15; const d = document.getElementById('timer-display-main'); if (d) { const m = Math.floor(State.restTimeLeft / 60); const s = State.restTimeLeft % 60; d.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; } }
            if (e.target.closest('#btn-timer-minus')) { State.restTimeLeft = Math.max(0, State.restTimeLeft - 15); const d = document.getElementById('timer-display-main'); if (d) { const m = Math.floor(State.restTimeLeft / 60); const s = State.restTimeLeft % 60; d.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; } }

            // RPE Y MAPA MUSCULAR AL FINALIZAR
            if (e.target.closest('#btn-next-exercise')) {
                if (State.currentExerciseIndex < State.activeWorkout.length - 1) {
                    State.currentExerciseIndex++;
                    navigateTo('workout_player');
                } else {
                    let workoutMuscles = {};
                    State.activeWorkout.forEach(ex => {
                        const data = EXERCISES.find(e => e.n === ex.name);
                        if (data && data.m) { if (!workoutMuscles[data.m]) workoutMuscles[data.m] = 0; workoutMuscles[data.m] += ex.sets.filter(s => s.done).length; }
                    });
                    document.getElementById('modal-rpe').classList.add('active');
                    renderHUDMap('workout-muscle-map', workoutMuscles);
                }
            }

            const btnRpe = e.target.closest('button[data-rpe]');
            if (btnRpe) {
                const rpeVal = btnRpe.dataset.rpe; const note = document.getElementById('workout-general-note').value;
                document.getElementById('modal-rpe').classList.remove('active');

                // GUARDAR EN FIRESTORE
                if (State.profile.uid) {
                    let totalSets = 0;
                    let workoutMuscles = {};
                    State.activeWorkout.forEach(ex => {
                        const data = EXERCISES.find(e => e.n === ex.name);
                        const doneSets = ex.sets.filter(s => s.done).length;
                        totalSets += doneSets;
                        if (data && data.m) { if (!workoutMuscles[data.m]) workoutMuscles[data.m] = 0; workoutMuscles[data.m] += doneSets; }
                    });

                    const record = {
                        rpe: parseInt(rpeVal),
                        note: note,
                        exercises: State.activeWorkout,
                        totalSets: totalSets,
                        muscles: workoutMuscles
                    };

                    saveWorkout(State.profile.uid, record).then(success => {
                        if (success) {
                            record.timestamp = new Date().toISOString();
                            if (!State.history) State.history = [];
                            State.history.unshift(record);
                        }
                    });

                    updateProfile(State.profile.uid, {
                        maxWeights: State.profile.maxWeights || {},
                        rmRecords: State.profile.rmRecords || {},
                        machineNotes: State.profile.machineNotes || {}
                    });
                }

                showToast(`üèÜ Entreno subido (RPE: ${rpeVal}). Eliminando de semana.`);
                State.activeWorkout = null;
                if (State.plan.routinesAvailable.length > 0) State.plan.routinesAvailable.shift();
                document.getElementById('workout-general-note').value = ''; navigateTo('historial');
            }
            if (e.target.closest('#btn-abort-workout')) { if (confirm("‚ö† ¬øAbortar entrenamiento?")) { State.activeWorkout = null; navigateTo('plan'); } }
        });
    </script>
</body>

</html>